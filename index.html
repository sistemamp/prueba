<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Causas</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    <style>
        /* TODO EL CSS ORIGINAL SE MANTIENE SIN CAMBIOS */
        :root {
            --primary-blue: #007bff;
            --primary-light-blue: #e7f4ff;
            --primary-dark-blue: #0056b3;
            --secondary-gray: #f8f9fa;
            --secondary-light-gray: #e9ecef;
            --secondary-dark-gray: #6c757d;
            --status-success: #28a745;
            --status-warning: #ff8c00;
            --status-danger: #dc3545;
            --status-info: #17a2b8;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-link: #007bff;
            --text-light: #ffffff;
            --background-default: #ffffff;
            --background-card: #ffffff;
            --background-header: #ffffff;
            --background-table-header: #f8f9fa;
            --border-default: #dee2e6;
            --font-family: 'Arial', 'Helvetica', sans-serif;
            --display-size: 24px;
            --h1-size: 20px;
            --h2-size: 18px;
            --body-large-size: 16px;
            --body-regular-size: 14px;
            --caption-size: 12px;
            --font-weight-regular: 400;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --spacing-unit: 8px;
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-gutter: 20px;
            --border-radius-small: 2px;
            --border-radius-default: 4px;
            --border-radius-pill: 20px;
            --shadow-none: none;
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,.08);
            --color-audiencias: #007bff;
            --color-vencimientos: #dc3545;
            --color-gesell: #28a745;
            --color-recursos: #6f42c1;
            --color-diligencias: #fd7e14;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-default);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }
        .header {
            background-color: var(--background-header);
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-s) var(--spacing-m);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-subtle);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
            gap: var(--spacing-s);
        }
        .logo {
            font-size: var(--h1-size);
            font-weight: var(--font-weight-bold);
            color: var(--primary-blue);
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--spacing-m) var(--spacing-gutter);
        }
        .filters-section {
            background-color: var(--background-card);
            padding: var(--spacing-m);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-subtle);
        }
        .filters-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-m);
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
        }
        .filter-row-1, .filter-row-2 {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
            width: 100%;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-label {
            display: block;
            font-size: var(--body-regular-size);
            margin-bottom: var(--spacing-xs);
            font-weight: var(--font-weight-semibold);
        }
        .input, .dropdown {
            border: 1px solid var(--border-default);
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s);
            background-color: var(--background-default);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
            width: 100%;
            transition: border-color 0.2s;
        }
        .input:focus, .dropdown:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        .action-buttons {
            display: flex;
            gap: var(--spacing-s);
            margin-top: var(--spacing-m);
            flex-wrap: wrap;
        }
        .button {
            background-color: var(--primary-blue);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius-default);
            padding: var(--spacing-s) var(--spacing-m);
            font-size: var(--body-regular-size);
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        .button:hover {
            opacity: 0.9;
        }
        .button-success {
            background-color: #1e7e34;
        }
        .button-secondary {
            background-color: var(--secondary-dark-gray);
        }
        .button-danger {
            background-color: var(--status-danger);
        }
        .table-section {
            background-color: var(--background-card);
            border-radius: var(--border-radius-default);
            border: 1px solid var(--border-default);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }
        .table-title {
            font-size: var(--h2-size);
            font-weight: var(--font-weight-semibold);
            padding: var(--spacing-m);
            background-color: var(--background-table-header);
            border-bottom: 1px solid var(--border-default);
        }
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        .data-table th {
            background-color: var(--background-table-header);
            font-weight: var(--font-weight-semibold);
            border-bottom: 2px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--caption-size);
            text-transform: uppercase;
        }
        .data-table td {
            border-bottom: 1px solid var(--border-default);
            padding: var(--spacing-m);
            color: var(--text-primary);
            font-size: var(--body-regular-size);
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover td {
            background-color: var(--secondary-gray);
        }
        .prioridad-pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
        }
        .prioridad-baja { background-color: var(--status-success); }
        .prioridad-media { background-color: var(--status-warning); }
        .prioridad-alta { background-color: var(--status-danger); }
        .prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        .prioridad-texto {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .prioridad-texto.alta { 
            background-color: rgba(220, 53, 69, 0.1); 
            color: var(--status-danger); 
            border: 2px solid var(--status-danger);
        }
        .prioridad-texto.media { 
            background-color: rgba(255, 140, 0, 0.1);
            color: var(--status-warning); 
            border: 2px solid var(--status-warning);
        }
        .prioridad-texto.baja { 
            background-color: rgba(40, 167, 69, 0.1); 
            color: var(--status-success); 
            border: 2px solid var(--status-success);
        }
        .prioridad-texto.ninguna { 
            background-color: rgba(108, 117, 125, 0.1); 
            color: var(--secondary-dark-gray); 
            border: 2px solid var(--secondary-dark-gray);
        }
        #paginacion-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-m);
            margin-top: var(--spacing-m);
            background: var(--background-card);
            border-radius: var(--border-radius-default);
            box-shadow: var(--shadow-subtle);
        }
        #paginacion-container .page-info {
            font-size: var(--body-regular-size);
            color: var(--text-secondary);
            font-weight: var(--font-weight-semibold);
        }
        #paginacion-container .nav-buttons {
            display: flex;
            gap: var(--spacing-s);
        }
        #modal, #modalVer, #alertModal, #modalEventosHoy, #modalIA {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        #modal .content, #modalVer .content, #alertModal .content, #modalEventosHoy .content, #modalIA .content {
            background: #fff;
            border-radius: 16px;
            max-width: 980px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: fadeIn .25s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            position: sticky;
            top: 0;
            background: var(--primary-blue);
            color: #fff;
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 16px 16px 0 0;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .modal-body {
            padding: 16px 16px 0;
            overflow-y: auto;
        }
        .controls-form {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 12px 16px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            z-index: 5;
        }
        #formCausa .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media(max-width:900px) { 
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
        }
        #formCausa label {
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 0.9rem;
            margin-bottom: 4px;
            display: block;
        }
        #formCausa input, #formCausa textarea, #formCausa select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 0.9rem;
            background: #fafafa;
            transition: .2s;
        }
        #formCausa input:focus, #formCausa textarea:focus, #formCausa select:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: #fff;
        }
        .counter {
            font-size: .8rem;
            color: #6b7280;
            margin-top: 4px;
        }
        #agregarNota {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4f9;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        #agregarNota label {
            font-weight: 600;
            color: var(--primary-blue);
            display: block;
            margin-bottom: 8px;
        }
        #agregarNota textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
        }
        #agregarNota button {
            background: var(--primary-blue);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        #verContenido p {
            margin: .35rem 0;
            font-size: .92rem;
        }
        #verContenido strong {
            color: var(--primary-blue);
        }
        .note {
            border-left: 3px solid var(--primary-blue);
            padding: 6px;
            margin: 6px 0;
            background: #f9fbff;
            border-radius: 6px;
        }
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        #alertModal .content {
            max-width: 400px;
            padding: 24px;
            text-align: center;
            gap: 16px;
        }
        #alertModal h3 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 1.5rem;
        }
        #alertModal p {
            margin: 0;
            color: var(--secondary-dark-gray);
            font-size: 0.95rem;
        }
        #alertModal .actions-row {
            display: flex;
            justify-content: space-around;
            gap: 12px;
            margin-top: 20px;
        }
        #alertModal .actions-row .btn {
            flex-grow: 1;
        }
        .alert-danger { background: var(--status-danger); color: white; }
        .alert-success { background: var(--status-success); color: white; }
        .floating-alert {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--status-danger);
            color: #fff;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            max-width: 500px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .floating-alert.success {
            background-color: var(--status-success);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }
        .floating-alert.show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }
        .floating-alert i {
            font-size: 1.3rem;
        }
        .audiencias-container {
            margin-bottom: 10px;
        }
        .audiencia-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .audiencia-item input {
            flex: 1;
        }
        .btn-eliminar-audiencia {
            background: var(--status-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-audiencia {
            background: var(--status-success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        .diligencias-container {
            margin-bottom: 10px;
        }
        .diligencia-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .diligencia-item input[type="datetime-local"] {
            flex: 1;
        }
        .diligencia-item input[type="text"] {
            flex: 2;
        }
        .btn-eliminar-diligencia {
            background: var(--status-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .btn-diligencia {
            background: var(--color-diligencias);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        .tabs-container {
            margin-bottom: 15px;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-button {
            background: #f0f0f0;
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-button.active {
            background: var(--primary-blue);
            color: #fff;
            position: relative;
            bottom: -2px;
            border-bottom: 2px solid var(--primary-blue);
        }
        .tab-content {
            padding: 15px 0;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-content .field:not(:last-child) {
            margin-bottom: 10px;
        }
        .field.error input,
        .field.error textarea,
        .field.error select {
            border-color: var(--status-danger);
            background-color: #ffeef0;
        }
        .field .error-message {
            color: var(--status-danger);
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }
        .field.error .error-message {
            display: block;
        }
        .field {
            margin-bottom: 15px;
        }
        #verContenido .prioridad-destacada {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            padding: 12px;
            border-radius: 12px;
            color: #fff;
        }
        .prioridad-destacada.prioridad-baja { background-color: var(--status-success); }
        .prioridad-destacada.prioridad-media { background-color: var(--status-warning); }
        .prioridad-destacada.prioridad-alta { background-color: var(--status-danger); }
        .prioridad-destacada.prioridad-ninguna { background-color: var(--secondary-dark-gray); }
        .notes-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .notes-history h4 {
            margin: 0 0 10px;
            color: var(--primary-blue);
            font-size: 1rem;
            border-bottom: 2px solid var(--primary-blue);
            padding-bottom: 5px;
        }
        .note-item {
            background: #f8f8f8;
            border-left: 4px solid var(--primary-blue);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--secondary-dark-gray);
            margin-bottom: 5px;
        }
        .note-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .editor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .editor-toolbar button {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .editor-toolbar button:hover {
            background: #e9ecef;
        }
        .editor-toolbar button.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        .color-button {
            font-weight: bold;
            min-width: 50px;
        }
        .color-button.azul {
            color: #007bff;
            border-color: #007bff;
        }
        .color-button.rojo {
            color: #dc3545;
            border-color: #dc3545;
        }
        .color-button.verde {
            color: #28a745;
            border-color: #28a745;
        }
        .color-button.normal {
            color: #212529;
            border-color: #6c757d;
        }
        #observaciones-editor {
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            background: #fff;
            line-height: 1.5;
        }
        #observaciones-editor:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        input[type="time"]::-moz-datetime-edit-ampm-field {
            display: none;
        }
        input[type="datetime-local"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        input[type="datetime-local"]::-moz-datetime-edit-ampm-field {
            display: none;
        }
        
        /* ESTILOS PARA LAS FUNCIONALIDADES DE VOZ */
        .voice-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .voice-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .voice-btn:hover {
            background: var(--primary-dark-blue);
        }
        .voice-btn.listening {
            background: var(--status-danger);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .voice-btn.speaking {
            background: var(--status-success);
        }
        .voice-status {
            font-size: 0.85rem;
            color: var(--secondary-dark-gray);
            font-style: italic;
            display: none;
        }
        .voice-status.active {
            display: inline;
            color: var(--status-info);
        }
        #voiceToolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .text-to-speech-btn {
            position: absolute;
            top: 12px;
            right: 16px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
        .text-to-speech-btn:hover {
            background: var(--primary-dark-blue);
        }
        .voice-input-container {
            position: relative;
        }
        .voice-input-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 4px;
        }
        .voice-input-btn:hover {
            color: var(--primary-dark-blue);
        }
        
        /* ================================================================ */
        /* NUEVOS ESTILOS PARA ASISTENTE IA - PANTALLA COMPLETA */
        /* ================================================================ */
        #modalIA {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        
        #modalIA .content {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            border-radius: 0;
            box-shadow: none;
            animation: none;
            display: flex;
            flex-direction: column;
        }
        
        #modalIA .modal-header {
            border-radius: 0;
            justify-content: space-between;
            padding: 12px 24px;
            flex-shrink: 0;
        }
        
        #modalIA .modal-header h2 {
            margin: 0;
            font-size: 1.4rem;
        }
        
        #modalIA .modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .ia-pantalla-completa-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .ia-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .ia-conversacion-wrapper {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .ia-conversacion {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .ia-mensaje {
            padding: 16px 20px;
            border-radius: 16px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
        }
        
        .ia-mensaje.usuario {
            background: var(--primary-blue);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .ia-mensaje.asistente {
            background: white;
            border: 1px solid #dee2e6;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .ia-mensaje-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .ia-mensaje-header strong {
            font-size: 0.95rem;
        }
        
        .ia-mensaje-acciones {
            display: flex;
            gap: 8px;
        }
        
        .ia-btn-voz {
            background: transparent;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .ia-btn-voz:hover {
            background: rgba(0, 123, 255, 0.1);
        }
        
        .ia-btn-voz.speaking {
            background: rgba(0, 123, 255, 0.2);
            color: var(--primary-dark-blue);
        }
        
        .ia-input-container-pantalla {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            padding: 16px 0;
            border-top: 1px solid #e9ecef;
        }
        
        .ia-input-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 8px 16px;
            border: 2px solid transparent;
            transition: border 0.2s;
        }
        
        .ia-input-wrapper:focus-within {
            border-color: var(--primary-blue);
        }
        
        .ia-input-wrapper input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 0;
            font-size: 1rem;
            outline: none;
        }
        
        .ia-btn-microfono {
            background: transparent;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .ia-btn-microfono:hover {
            background: rgba(0, 123, 255, 0.1);
        }
        
        .ia-btn-microfono.listening {
            background: var(--status-danger);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .ia-btn-enviar {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .ia-btn-enviar:hover {
            background: var(--primary-dark-blue);
        }
        
        .ia-botones-control {
            display: flex;
            gap: 12px;
        }
        
        .ia-botones-control .button {
            padding: 10px 20px;
        }
        
        .ia-resultado-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-blue);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .ia-resultado-card:hover {
            transform: translateX(5px);
            background: #f8f9fa;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .ia-card-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .ia-card-title {
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 6px;
            display: block;
            font-size: 1rem;
        }
        
        .ia-card-body {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .ia-highlight {
            background-color: #fff3cd;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .ia-analisis-detallado {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-blue);
        }
        
        .ia-analisis-detallado h4 {
            color: var(--primary-blue);
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .ia-estadistica-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .ia-estadistica-item:last-child {
            border-bottom: none;
        }
        
        .ia-estadistica-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .ia-estadistica-valor {
            font-weight: 700;
            color: var(--primary-blue);
        }
        
        .ia-lista-expedientes {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid #dee2e6;
        }
        
        .ia-expediente-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .ia-expediente-item:last-child {
            border-bottom: none;
        }
        
        .ia-expediente-numero {
            font-weight: bold;
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
        }
        
        .ia-expediente-numero:hover {
            color: var(--primary-dark-blue);
        }
        
        .ia-expediente-datos {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* NUEVOS ESTILOS PARA CHIPS DE SUGERENCIAS */
        .ia-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .ia-chip {
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .ia-chip:hover {
            background: #dee2e6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .ia-chip.prioridad-alta {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--status-danger);
            color: var(--status-danger);
        }
        
        .ia-chip.vencimientos {
            background: rgba(255, 140, 0, 0.1);
            border-color: var(--color-vencimientos);
            color: var(--color-vencimientos);
        }
        
        .ia-chip.estadisticas {
            background: rgba(23, 162, 184, 0.1);
            border-color: var(--status-info);
            color: var(--status-info);
        }
        
        /* ANIMACIÃ“N DE PUNTOS PARA PENSAR */
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }
        
        .ia-pensando::after {
            content: "...";
            animation: dots 1.5s steps(1, end) infinite;
        }
        
        .ia-mensaje-carga {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 16px;
            padding: 16px 20px;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--secondary-dark-gray);
        }
        
        @media print {
            .button, .actions, .action-buttons, .controls-form,
            #btnNuevo, #btnPrintListado, #btnPrintFechas, #btnPrintForm,
            #btnPrintRegistro, #btnCerrarVer, #btnAgregarNota, #btnVerLineaTiempo,
            #btnPrintTodos, #btnPrintFiltrado, #btnEventosHoy, #btnAsistenteIA,
            .fa-solid, .fas, .far, .fa, .fa-eye, .fa-pen, .fa-trash, .fa-plus,
            .fa-save, .fa-print, .fa-xmark, .fa-check, .fa-arrow-left, .fa-arrow-right,
            .fa-exclamation-triangle, .fa-timeline, .fa-file-pen, .fa-calendar-day,
            .btn-eliminar-audiencia, .btn-audiencia, .floating-alert,
            .prioridad-destacada, .tabs-nav, .tab-button, .editor-toolbar,
            .voice-controls, .voice-btn, .text-to-speech-btn, .voice-input-btn {
                display: none !important;
            }
            .header, .filters-section, .sidebar, .pagination-container {
                display: none !important;
            }
            body, .container, .main-layout, .main {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            .table-section, .kpi-section, .modal .content, #modalVer .content {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            .data-table {
                min-width: 100% !important;
            }
            .kpi-cards {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }
            .prioridad-pill {
                color: #000 !important;
                background-color: transparent !important;
                border: 1px solid #000 !important;
            }
            .tab-content {
                display: block !important;
            }
            #formCausa .grid {
                display: table !important;
                width: 100% !important;
            }
            .field {
                display: table-row !important;
                margin-bottom: 0 !important;
            }
            .field label {
                display: table-cell !important;
                padding: 8px !important;
                font-weight: bold !important;
                width: 40% !important;
                border-bottom: 1px solid #ddd !important;
            }
            .field input, .field textarea, .field select {
                display: table-cell !important;
                width: 100% !important;
                padding: 8px !important;
                border: none !important;
                border-bottom: 1px solid #ddd !important;
                background: transparent !important;
            }
            .field textarea {
                height: auto !important;
                min-height: 60px !important;
            }
            .prioridad-texto {
                color: #000 !important;
                background-color: transparent !important;
                border: 1px solid #000 !important;
                font-weight: bold !important;
            }
            #observaciones-editor {
                border: none !important;
                padding: 0 !important;
                min-height: auto !important;
                max-height: none !important;
            }
            #modalIA {
                display: none !important;
            }
        }
        /* Estilos para el modal de eventos de hoy */
        #modalEventosHoy .content {
            max-width: 500px;
        }
        .eventos-hoy-modal {
            padding: 10px;
        }
        .evento-titulo {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid;
            font-size: 1rem;
        }
        .evento-audiencias { color: var(--color-audiencias); border-color: var(--color-audiencias); }
        .evento-vencimientos { color: var(--color-vencimientos); border-color: var(--color-vencimientos); }
        .evento-gesell { color: var(--color-gesell); border-color: var(--color-gesell); }
        .evento-recursos { color: var(--color-recursos); border-color: var(--color-recursos); }
        .evento-diligencias { color: var(--color-diligencias); border-color: var(--color-diligencias); }
        .evento-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid;
            transition: all 0.2s;
        }
        .evento-item-audiencias { border-left-color: var(--color-audiencias); }
        .evento-item-vencimientos { border-left-color: var(--color-vencimientos); }
        .evento-item-gesell { border-left-color: var(--color-gesell); }
        .evento-item-recursos { border-left-color: var(--color-recursos); }
        .evento-item-diligencias { border-left-color: var(--color-diligencias); }
        .evento-item:hover {
            background: #e9ecef;
        }
        .evento-numero {
            font-weight: bold;
            color: var(--primary-blue);
            cursor: pointer;
            text-decoration: underline;
        }
        .evento-numero:hover {
            color: var(--primary-dark-blue);
        }
        .evento-hora {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .evento-vacio {
            font-style: italic;
            color: var(--text-secondary);
            padding: 6px 8px;
        }
        .eventos-lista {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        .evento-tabla {
            padding: 4px 6px;
            margin-bottom: 3px;
            border-left: 3px solid;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .evento-tabla.audiencia { border-left-color: var(--color-audiencias); }
        .evento-tabla.gesell { border-left-color: var(--color-gesell); }
        .evento-tabla.vencimiento { border-left-color: var(--color-vencimientos); }
        .evento-tabla.recurso { border-left-color: var(--color-recursos); }
        .evento-tabla.diligencia { border-left-color: var(--color-diligencias); }
        @media (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: var(--spacing-s);
            }
            #modal .content, #modalVer .content, #modalEventosHoy .content, #modalIA .content {
                max-width: 95%;
            }
            .filter-row-1, .filter-row-2 {
                flex-wrap: wrap;
            }
            .filter-group {
                min-width: 120px;
            }
            .ia-pantalla-completa-container {
                padding: 15px;
            }
        }
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: var(--spacing-s);
                text-align: center;
            }
            .filter-row {
                flex-direction: column;
            }
            .filter-group {
                min-width: auto;
            }
            #paginacion-container {
                flex-direction: column;
                gap: var(--spacing-m);
                text-align: center;
            }
            .table-title {
                padding: var(--spacing-s);
            }
            .data-table th, 
            .data-table td {
                padding: var(--spacing-s);
            }
            .action-buttons {
                flex-direction: column;
            }
            .controls-form {
                flex-direction: column;
            }
            #formCausa .grid {
                grid-template-columns: 1fr;
            }
            .tabs-nav {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .tab-button {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            .data-table {
                min-width: 600px;
            }
            .actions {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 4px;
            }
            .editor-toolbar {
                flex-wrap: wrap;
            }
            .filter-row-1, .filter-row-2 {
                flex-direction: column;
            }
            .voice-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .text-to-speech-btn {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 10px;
                align-self: flex-end;
            }
            .ia-input-container-pantalla {
                flex-direction: column;
            }
            .ia-botones-control {
                flex-direction: column;
                width: 100%;
            }
            .ia-botones-control .button {
                width: 100%;
            }
            .ia-conversacion-wrapper {
                padding: 15px;
            }
            .ia-mensaje {
                max-width: 90%;
                padding: 14px 16px;
            }
        }
        @media (max-width: 576px) {
            .container {
                padding: var(--spacing-xs);
                width: 100%;
            }
            .filters-section,
            .table-section {
                padding: var(--spacing-s);
            }
            .filters-title,
            .table-title {
                font-size: var(--body-large-size);
            }
            #modal .content, #modalVer .content, #modalEventosHoy .content, #modalIA .content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            .modal-header,
            .modal-body,
            .controls-form {
                padding: var(--spacing-s);
            }
            .filter-group {
                width: 100%;
            }
            .button {
                width: 100%;
                justify-content: center;
            }
            .tab-button {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            .table-wrap {
                margin: 0 -8px;
                padding: 0 8px;
            }
            .data-table {
                min-width: 100%;
            }
            .prioridad-pill {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            .actions .button {
                width: 100%;
                font-size: 0.85rem;
            }
            .floating-alert {
                max-width: 90%;
                font-size: 0.9rem;
                padding: 10px 15px;
            }
            .editor-toolbar {
                padding: 6px;
            }
            .editor-toolbar button {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            .voice-btn {
                width: 100%;
                justify-content: center;
            }
            .ia-header-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .ia-mensaje-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .ia-mensaje-acciones {
                align-self: flex-end;
            }
        }
        @media (max-width: 360px) {
            .container {
                padding: 4px;
            }
            .filters-section,
            .table-section {
                padding: 8px;
            }
            .tab-button {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            .data-table th, 
            .data-table td {
                padding: 6px;
                font-size: 0.8rem;
            }
            .button {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            .ia-pantalla-completa-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="floating-alert" id="floating-alert">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="floating-alert-text"></span>
    </div>
    
    <header class="header">
        <div class="header-content">
            <button id="btnNuevo" class="button">
                <i class="fas fa-plus"></i> Nuevo Expediente
            </button>
            <button id="btnEventosHoy" class="button">
                <i class="fas fa-calendar-day"></i> Eventos Hoy
            </button>
            <button id="btnAsistenteIA" class="button">
                Asistente IA
            </button>
        </div>
    </header>
    <main class="container">
        <section class="filters-section">
            <h2 class="filters-title">Filtros de BÃºsqueda</h2>
            <div class="filter-row">
                <div class="filter-row-1">
                    <div class="filter-group">
                        <label class="filter-label" for="buscador">BÃºsqueda</label>
                        <div class="voice-input-container">
                            <input type="text" id="buscador" class="input" placeholder="ðŸ” Buscar...">
                            <button class="voice-input-btn" id="btnVoiceSearch" title="BÃºsqueda por voz">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroTipoProceso">Tipo de Proceso</label>
                        <select id="filtroTipoProceso" class="dropdown">
                            <option value="">Tipo de Proceso (todos)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroIntervencion">IntervenciÃ³n</label>
                        <select id="filtroIntervencion" class="dropdown">
                            <option value="">IntervenciÃ³n (todas)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroEstado">Estado</label>
                        <select id="filtroEstado" class="dropdown">
                            <option value="">Estado (todos)</option>
                            <option>En trÃ¡mite</option><option>Finalizado</option><option>En Alzada</option><option>Archivado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroUsuario">Usuario</label>
                        <select id="filtroUsuario" class="dropdown">
                            <option value="">Usuario (todos)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroPrioridad">Prioridad</label>
                        <select id="filtroPrioridad" class="dropdown">
                            <option value="">Prioridad (todas)</option>
                            <option value="Ninguna">Ninguna</option>
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row-2">
                    <div class="filter-group">
                        <label class="filter-label" for="filtroEventos">Filtrar por Evento</label>
                        <select id="filtroEventos" class="dropdown">
                            <option value="">Todos los eventos</option>
                            <option value="audiencias">Audiencias</option>
                            <option value="gesell">CÃ¡mara Gesell</option>
                            <option value="vencimientos">Vencimientos</option>
                            <option value="recursos">Recursos</option>
                            <option value="diligencias">Diligencias</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroFechaDesde">Fecha Desde</label>
                        <input type="date" id="filtroFechaDesde" class="input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="filtroFechaHasta">Fecha Hasta</label>
                        <input type="date" id="filtroFechaHasta" class="input">
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button id="btnPrintFiltrado" class="button button-success">
                    <i class="fas fa-print"></i> Imprimir Filtrado
                </button>
            </div>
        </section>
        <section class="table-section">
            <h2 class="table-title">Expedientes Judiciales</h2>
            <div class="table-wrap">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>NÂ°</th>
                            <th>CarÃ¡tula</th>
                            <th>Tipo</th>
                            <th>Juzgado</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Registro</th>
                            <th>Eventos</th>
                            <th class="no-print">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCausas">
                        <tr>
                            <td colspan="10">Cargando expedientes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <div id="paginacion-container"></div>
    </main>

    <!-- MODAL ASISTENTE IA - PANTALLA COMPLETA -->
    <div id="modalIA">
        <div class="content">
            <div class="modal-header">
                <h2 style="margin:0;">Asistente IA - AnÃ¡lisis Inteligente</h2>
            </div>
            <div class="modal-body">
                <div class="ia-pantalla-completa-container">
                    <div class="ia-header-controls">
                        <div class="ia-botones-control">
                            <button id="btnNuevaConsultaIA" class="button button-secondary">
                                <i class="fas fa-plus-circle"></i> Nueva Consulta
                            </button>
                            <button id="btnSalirIA" class="button button-danger">
                                <i class="fas fa-sign-out-alt"></i> Salir
                            </button>
                        </div>
                    </div>
                    
                    <div class="ia-conversacion-wrapper">
                        <div class="ia-conversacion" id="iaConversacion">
                            <!-- La conversaciÃ³n se insertarÃ¡ aquÃ­ dinÃ¡micamente -->
                        </div>
                    </div>
                    
                    <div class="ia-input-container-pantalla">
                        <div class="ia-input-wrapper">
                            <input type="text" id="iaPregunta" placeholder="Escribe tu pregunta o usa el micrÃ³fono..." autocomplete="off">
                            <button id="btnVoiceIA" class="ia-btn-microfono" title="Usar voz para consultar">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <button id="iaEnviar" class="ia-btn-enviar">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                    
                    <div class="ia-chips-container" id="iaChipsContainer">
                        <!-- Los chips se generarÃ¡n dinÃ¡micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EVENTOS HOY -->
    <div id="modalEventosHoy">
        <div class="content">
            <div class="modal-header">
                <i class="fas fa-calendar-day"></i>
                <h2 style="margin:0;">Eventos de Hoy</h2>
            </div>
            <div class="modal-body eventos-hoy-modal">
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-audiencias">Audiencias</div>
                    <div id="listAudHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-gesell">CÃ¡mara Gesell</div>
                    <div id="listGesellHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-vencimientos">Vencimientos</div>
                    <div id="listVencHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-recursos">Recursos</div>
                    <div id="listRecursosHoy"></div>
                </div>
                <div class="eventos-hoy">
                    <div class="evento-titulo evento-diligencias">Diligencias</div>
                    <div id="listDiligenciasHoy"></div>
                </div>
            </div>
            <div class="controls-form">
                <button id="btnCerrarEventosHoy" class="button button-secondary">
                    <i class="fa fa-xmark"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- MODALES EXISTENTES -->
    <div id="modal">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-file-pen"></i>
                <h2 id="tituloForm" style="margin:0;">Nuevo Expediente</h2>
            </div>
            <div class="modal-body">
                <form id="formCausa" action="#" method="post" aria-label="Formulario para nuevo expediente o ediciÃ³n">
                    <input type="hidden" id="editId" />
                    <div class="tabs-container">
                        <div class="tabs-nav">
                            <button type="button" class="tab-button active" data-tab="tab1">Datos Principales</button>
                            <button type="button" class="tab-button" data-tab="tab2">Fechas</button>
                            <button type="button" class="tab-button" data-tab="tab3">Audiencias</button>
                            <button type="button" class="tab-button" data-tab="tab4">Vencimientos</button>
                            <button type="button" class="tab-button" data-tab="tab5">Diligencias</button>
                            <button type="button" class="tab-button" data-tab="tab6">Recursos</button>
                            <button type="button" class="tab-button" data-tab="tab7">Observaciones</button>
                        </div>
                        <div id="tab1" class="tab-content active">
                            <div class="field">
                                <label for="numCausa">NÂ° Expediente *</label>
                                <input id="numCausa" required autocomplete="off" />
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="caratula">CarÃ¡tula Completa *</label>
                                <div class="voice-input-container">
                                    <textarea id="caratula" rows="2" required></textarea>
                                    <button class="voice-input-btn" id="btnVoiceCaratula" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="tipoProceso">Tipo de Proceso *</label>
                                <select id="tipoProceso" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="juzgado">Juzgado *</label>
                                <select id="juzgado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="prioridad">Prioridad *</label>
                                <select id="prioridad" required>
                                    <option value="Ninguna"><strong>Ninguna</strong> (gris)</option>
                                    <option value="Baja"><strong>Baja</strong> (verde)</option>
                                    <option value="Media"><strong>Media</strong> (naranja)</option>
                                    <option value="Alta"><strong>Alta</strong> (roja)</option>
                                </select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="usuarioAsignado">Usuario Asignado *</label>
                                <select id="usuarioAsignado" required></select>
                                <span class="error-message">Este campo es obligatorio.</span>
                            </div>
                            <div class="field">
                                <label for="estado">Estado del Proceso</label>
                                <select id="estado"><option>En trÃ¡mite</option><option>Finalizado</option><option>Archivado</option><option>En Alzada</option></select>
                            </div>
                            <div class="field">
                                <label for="intervencion">IntervenciÃ³n</label>
                                <select id="intervencion">
                                    <option>Defensor Oficial</option><option>Ministerio Principal</option><option>Ministerio Complementario</option><option>Patrocinante Actor</option>
                                    <option>Patrocinante Demandado</option><option>Patrocinante Tercero</option><option value="Defensor de Ausente">Defensor de Ausente</option><option>Patrocinante presunto incapaz</option></option>
                                    <option value="Defensor Oficial Asesor Letrado">Asistencia Letrada del incapaz</option><option>Ministerio PÃºblico del incapaz</option><option>Ministerio PÃºblico en turno Abril</option><option>Ministerio PÃºblico en turno Agosto</option><option>Ministerio PÃºblico en turno Diciembre</option><option>Tutor Ad Litem</option><option>Defensor Oficial Art 329 CPCC</option><option>Defensor Oficial Art 626 CPCC</option>   
                                </select>
                            </div>
                            <div class="field">
                                <label for="datosNnya">Datos de NNyA (mÃ¡x. 500 palabras)</label>
                                <div class="voice-input-container">
                                    <textarea id="datosNnya" disabled></textarea>
                                    <button class="voice-input-btn" id="btnVoiceDatosNnya" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                                <div class="counter" id="counterNnya" style="display:none">0/500</div>
                            </div>
                        </div>
                        <div id="tab2" class="tab-content">
                            <div class="field"><label for="fechaInicio">Fecha de Inicio</label><input type="date" id="fechaInicio" /></div>
                            <div class="field"><label for="fechaPase">Fecha de Pase</label><input type="datetime-local" id="fechaPase" /></div>
                        </div>
                        <div id="tab3" class="tab-content">
                            <div class="field">
                                <label for="audiencias">Audiencias seÃ±aladas</label>
                                <div id="audiencias-container" class="audiencias-container"></div>
                                <button type="button" id="btnAgregarAudiencia" class="btn-audiencia"><i class="fa fa-plus"></i> Agregar Audiencia</button>
                            </div>
                            <div class="field">
                                <label for="audienciaGesell">Audiencia en CÃ¡mara Gesell</label>
                                <div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="habilitarAudienciaGesell" /><span>Habilitar</span></div>
                                <input type="datetime-local" id="audienciaGesell" disabled />
                            </div>
                            <div class="field">
                                <label for="nnyaGesell">NNyA en Gesell (mÃ¡x. 400 palabras)</label>
                                <div class="voice-input-container">
                                    <textarea id="nnyaGesell" disabled></textarea>
                                    <button class="voice-input-btn" id="btnVoiceNnyaGesell" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                                <div class="counter" id="counterNnyaGesell" style="display:none">0/400</div>
                            </div>
                        </div>
                        <div id="tab4" class="tab-content">
                            <div class="field"><label for="vencimiento">Vencimiento</label><input type="datetime-local" id="vencimiento" /></div>
                            <div class="field"><label for="vencimientoRecursos">Vencimiento de Recursos</label><input type="datetime-local" id="vencimientoRecursos" /></div>
                        </div>
                        <div id="tab5" class="tab-content">
                            <div class="field">
                                <label for="diligencias">Diligencias</label>
                                <div id="diligencias-container" class="diligencias-container"></div>
                                <button type="button" id="btnAgregarDiligencia" class="btn-diligencia"><i class="fa fa-plus"></i> Agregar Diligencia</button>
                            </div>
                        </div>
                        <div id="tab6" class="tab-content">
                            <div class="field">
                                <label for="recursos">Recursos Interpuestos</label>
                                <select id="recursos"><option value="">Seleccione un recurso</option><option>ApelaciÃ³n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>ReposiciÃ³n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                            </div>
                            <div id="recursos-opcionales" style="display:none;">
                                <div class="field">
                                    <label for="recursosContestacion">Recursos ContestaciÃ³n</label>
                                    <select id="recursosContestacion"><option value="">Seleccione un recurso</option><option>ApelaciÃ³n</option><option>Queja</option><option>Inconstitucionalidad</option><option>Nulidad</option><option>ReposiciÃ³n</option><option>Aclaratoria</option><option>Recurso Extraordinario</option><option>Recurso de Inaplicabilidad</option></select>
                                </div>
                                <div class="field">
                                    <label for="estadoRecursos">Estado de Recursos</label>
                                    <select id="estadoRecursos"><option value="">Seleccione un estado</option><option>Pendiente</option><option>En trÃ¡mite</option<option>Resuelto</option><option>Rechazado</option></select>
                                </div>
                            </div>
                        </div>
                        <div id="tab7" class="tab-content">
                            <div class="field">
                                <label for="observaciones">Observaciones (mÃ¡x. 1000 palabras)</label>
                                <div id="voiceToolbar" class="editor-toolbar">
                                    <button type="button" id="btnBold" title="Negrita"><i class="fas fa-bold"></i></button>
                                    <button type="button" id="btnColorAzul" class="color-button azul" title="Color Azul">A</button>
                                    <button type="button" id="btnColorRojo" class="color-button rojo" title="Color Rojo">A</button>
                                    <button type="button" id="btnColorVerde" class="color-button verde" title="Color Verde">A</button>
                                    <button type="button" id="btnColorNormal" class="color-button normal" title="Color Normal">Normal</button>
                                    <button type="button" id="btnVoiceObservaciones" class="voice-btn" title="Dictado por voz">
                                        <i class="fas fa-microphone"></i> Voz
                                    </button>
                                </div>
                                <div id="observaciones-editor" contenteditable="true"></div>
                                <input type="hidden" id="observaciones" name="observaciones">
                                <div class="counter" id="counter">0/1000</div>
                                <div class="voice-controls">
                                    <span class="voice-status" id="voiceStatus"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="controls-form">
                <button class="button button-success" type="button" id="btnGuardar"><i class="fa fa-save"></i>Guardar</button>
            </div>
        </div>
    </div>
    <div id="modalVer">
        <div class="content">
            <div class="modal-header">
                <i class="fa-solid fa-eye"></i>
                <h2 style="margin:0;">Detalle del Expediente</h2>
                <button class="text-to-speech-btn" id="btnTextToSpeech" title="Escuchar contenido">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="verContenido"></div>
                <div id="agregarNota">
                    <label for="notaBitacora">Agregar Nota de Seguimiento:</label>
                    <div class="voice-input-container">
                        <textarea id="notaBitacora" placeholder="Escribe aquÃ­ la nota..."></textarea>
                        <button class="voice-input-btn" id="btnVoiceNota" title="Dictado por voz">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <button id="btnAgregarNota" class="button"><i class="fa fa-plus"></i> Guardar Nota</button>
                </div>
                <div class="notes-history">
                    <h4>Historial de Notas</h4>
                    <div id="historialNotas"></div>
                </div>
            </div>
            <div class="controls-form" style="justify-content:flex-end;">
                <button id="btnCerrarVer" class="button button-secondary"><i class="fa fa-xmark"></i>Cerrar</button>
                <button id="btnPrintRegistro" class="button button-success"><i class="fa fa-print"></i>Imprimir Registro</button>
            </div>
        </div>
    </div>
    <div id="alertModal">
        <div class="content">
            <h3 id="alertTitle"></h3>
            <p id="alertMessage"></p>
            <div class="actions-row">
                <button id="btnAlertOK" class="button alert-success"><i class="fa fa-check"></i> OK</button>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
            authDomain: "causas-defensoria.firebaseapp.com",
            projectId: "causas-defensoria",
            storageBucket: "causas-defensoria.appspot.com",
            messagingSenderId: "186064671470",
            appId: "1:186064671470:web:b58bae5eadbe6e469f19ff"
        };
        
        let app;
        let db;
        
        try {
            if (firebase.apps && firebase.apps.length > 0) {
                app = firebase.app();
                console.log("Firebase ya estÃ¡ inicializado");
            } else {
                console.log("Inicializando Firebase...");
                app = firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log("Firebase Firestore inicializado correctamente");
            
            try {
                db.enablePersistence()
                    .then(() => {
                        console.log("Persistencia habilitada. Los datos se almacenarÃ¡n en cachÃ© en el navegador.");
                    })
                    .catch((err) => {
                        console.warn("No se pudo habilitar la persistencia: ", err);
                        if (err.code === 'failed-precondition') {
                            console.warn("MÃºltiples pestaÃ±as abiertas. La persistencia solo se puede habilitar en una pestaÃ±a a la vez.");
                        } else if (err.code === 'unimplemented') {
                            console.warn("El navegador no soporta persistencia. La aplicaciÃ³n funcionarÃ¡ sin cachÃ© local.");
                        }
                    });
            } catch (e) {
                console.warn("Error al habilitar persistencia: ", e);
            }
            
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            mostrarAlertaFlotante("Error al conectar con la base de datos. Por favor, recarga la pÃ¡gina.", 'danger');
        }

        let modo = "nuevo";
        let datosCache = [];
        let paginaActual = 1;
        let datosFiltrados = [];
        let causaActualId = null;
        let unsubCausas = null;
        let usuariosCache = [];
        let juzgadosPorTipoCache = {};
        let filterTimeout = null;
        
        // VARIABLES PARA EL ASISTENTE IA (MEMORIA DE CONTEXTO)
        let ultimoResultadoIA = []; // Memoria de contexto
        let contextoActivo = false; // Indica si hay un contexto activo para refinar
        
        const recordsPerPage = 10;
        const intervencionOptions = [
            "Defensor Oficial","Ministerio Principal", "Ministerio Complementario", "Patrocinante Actor",
            "Patrocinante Demandado", "Patrocinante Tercero", "Defensor de Ausente",
            "Patrocinante presunto incapaz", "Asesor Letrado", "Ministerio PÃºblico del incapaz",
            "Ministerio PÃºblico en turno Abril", "Ministerio PÃºblico en turno Agosto",
            "Ministerio PÃºblico en turno Diciembre", "Asistencia Letrada del incapaz","Tutor Ad Litem","Defensor Oficial Art 329 CPCC", "Defensor Oficial Art 626 CPCC"   
        ];
        
        const $ = (id) => document.getElementById(id);
        const tbody = $("tbodyCausas");
        const modal = $("modal");
        const modalVer = $("modalVer");
        const modalEventosHoy = $("modalEventosHoy");
        const modalIA = $("modalIA");
        const verContenido = $("verContenido");
        const tituloForm = $("tituloForm");
        const editId = $("editId");
        const buscador = $("buscador");
        const filtroEstado = $("filtroEstado");
        const filtroUsuario = $("filtroUsuario");
        const filtroPrioridad = $("filtroPrioridad");
        const filtroIntervencion = $("filtroIntervencion");
        const filtroTipoProceso = $("filtroTipoProceso");
        const filtroEventos = $("filtroEventos");
        const filtroFechaDesde = $("filtroFechaDesde");
        const filtroFechaHasta = $("filtroFechaHasta");
        const notaBitacora = $("notaBitacora");
        const historialNotas = $("historialNotas");
        const btnAgregarNota = $("btnAgregarNota");
        const listAudHoy = $("listAudHoy");
        const listGesellHoy = $("listGesellHoy");
        const listVencHoy = $("listVencHoy");
        const listRecursosHoy = $("listRecursosHoy");
        const listDiligenciasHoy = $("listDiligenciasHoy");
        const floatingAlert = $("floating-alert");
        const floatingAlertText = $("floating-alert-text");
        const audienciasContainer = $("audiencias-container");
        const diligenciasContainer = $("diligencias-container");
        const btnAgregarAudiencia = $("btnAgregarAudiencia");
        const btnAgregarDiligencia = $("btnAgregarDiligencia");
        const alertModal = $("alertModal");
        const alertTitle = $("alertTitle");
        const alertMessage = $("alertMessage");
        const btnAlertOK = $("btnAlertOK");
        const iaConversacion = $("iaConversacion");
        const iaPregunta = $("iaPregunta");
        const iaEnviar = $("iaEnviar");
        const btnAsistenteIA = $("btnAsistenteIA");
        const btnNuevaConsultaIA = $("btnNuevaConsultaIA");
        const btnSalirIA = $("btnSalirIA");
        const btnVoiceIA = $("btnVoiceIA");
        const iaChipsContainer = $("iaChipsContainer");
        
        const selTipo = $("tipoProceso"), selJuz = $("juzgado"), selUsu = $("usuarioAsignado"), selPrioridad = $("prioridad");
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        
        const btnBold = $("btnBold");
        const btnColorAzul = $("btnColorAzul");
        const btnColorRojo = $("btnColorRojo");
        const btnColorVerde = $("btnColorVerde");
        const btnColorNormal = $("btnColorNormal");
        const observacionesEditor = $("observaciones-editor");
        const observacionesHidden = $("observaciones");
        
        const toDate = (v) => v?.toDate ? v.toDate() : (v?.seconds ? new Date(v.seconds*1000) : (v ? new Date(v) : null));
        
        function formatearFecha(d, conHora = false) {
            const fecha = toDate(d);
            if (!fecha || isNaN(fecha)) return "";
            const dia = String(fecha.getDate()).padStart(2, '0');
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const aÃ±o = fecha.getFullYear();
            if (!conHora) {
                return `${dia}/${mes}/${aÃ±o}`;
            }
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${aÃ±o} ${horas}:${minutos}`;
        }
        
        function formatFechaParaInput(fecha, conHora = true) {
            if (!fecha || isNaN(fecha)) return "";
            
            const aÃ±o = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const dia = String(fecha.getDate()).padStart(2, '0');
            
            if (!conHora) {
                return `${aÃ±o}-${mes}-${dia}`;
            }
            
            const horas = String(fecha.getHours()).padStart(2, '0');
            const minutos = String(fecha.getMinutes()).padStart(2, '0');
            return `${aÃ±o}-${mes}-${dia}T${horas}:${minutos}`;
        }
        
        const prioridadClase = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "prioridad-alta";
            if(p === "media") return "prioridad-media";
            if(p === "baja") return "prioridad-baja";
            return "prioridad-ninguna";
        };
        
        const prioridadClaseTexto = (p) => {
            p = (p || "Ninguna").toLowerCase();
            if(p === "alta") return "alta";
            if(p === "media") return "media";
            if(p === "baja") return "baja";
            return "ninguna";
        };
        
        function mostrarAlertaFlotante(mensaje, tipo = 'danger') {
            if (!floatingAlertText) {
                console.error("Elemento floating-alert-text no encontrado");
                return;
            }
            
            floatingAlertText.textContent = mensaje;
            floatingAlert.classList.remove('danger', 'success', 'show');
            floatingAlert.classList.add(tipo);
            
            const icon = floatingAlert.querySelector('i');
            if (icon) {
                icon.style.display = 'block';
            }
            
            setTimeout(() => {
                floatingAlert.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                floatingAlert.classList.remove('show');
            }, 5000);
        }
        
        // FUNCIÃ“N PARA VALIDAR EXISTENCIA DE EXPEDIENTE
        function validarExistenciaExpediente() {
            const numCausaInput = $("numCausa");
            const numCausa = numCausaInput.value.trim();
            const numCausaField = numCausaInput.closest('.field');
            const errorSpan = numCausaField.querySelector('.error-message');
            
            if (modo === "nuevo" && numCausa) {
                const existe = datosCache.some(causa => causa.numCausa === numCausa);
                
                if (existe) {
                    numCausaField.classList.add('error');
                    errorSpan.textContent = "Este nÃºmero de expediente ya estÃ¡ registrado";
                    errorSpan.style.color = "#dc3545";
                    errorSpan.style.fontWeight = "bold";
                    
                    mostrarAlertaFlotante("El nÃºmero de expediente ya existe en el sistema. Verifique e intente con otro nÃºmero.", 'danger');
                    
                    deshabilitarCamposFormulario(true);
                } else {
                    numCausaField.classList.remove('error');
                    errorSpan.textContent = "Este campo es obligatorio.";
                    errorSpan.style.color = "";
                    errorSpan.style.fontWeight = "";
                    
                    deshabilitarCamposFormulario(false);
                }
            } else if (modo === "editar") {
                if (!numCausa) {
                    numCausaField.classList.add('error');
                    errorSpan.textContent = "Este campo es obligatorio.";
                } else {
                    numCausaField.classList.remove('error');
                }
                errorSpan.style.color = "";
                errorSpan.style.fontWeight = "";
            }
        }

        function deshabilitarCamposFormulario(deshabilitar) {
            const campos = document.querySelectorAll('#formCausa input:not(#numCausa), #formCausa textarea, #formCausa select');
            const btnGuardar = $("btnGuardar");
            
            campos.forEach(campo => {
                campo.disabled = deshabilitar;
            });
            
            if (btnGuardar) {
                btnGuardar.disabled = deshabilitar;
                btnGuardar.style.opacity = deshabilitar ? "0.5" : "1";
                btnGuardar.style.cursor = deshabilitar ? "not-allowed" : "pointer";
            }
        }
        
        // FUNCIONES FALTANTES AÃ‘ADIDAS
        function recolectarDatosForm() {
            const datos = {
                numCausa: $("numCausa").value.trim(),
                caratula: $("caratula").value.trim(),
                tipoProceso: $("tipoProceso").value,
                juzgado: $("juzgado").value,
                prioridad: $("prioridad").value,
                usuarioAsignado: $("usuarioAsignado").value,
                estado: $("estado").value,
                intervencion: $("intervencion").value,
                datosNnya: $("datosNnya").value.trim(),
                fechaInicio: $("fechaInicio").value || null,
                fechaPase: $("fechaPase").value || null,
                audienciaGesell: $("habilitarAudienciaGesell").checked ? $("audienciaGesell").value : null,
                nnyaGesell: $("nnyaGesell").value.trim(),
                vencimiento: $("vencimiento").value || null,
                vencimientoRecursos: $("vencimientoRecursos").value || null,
                recursos: $("recursos").value || null,
                recursosContestacion: $("recursosContestacion").value || null,
                estadoRecursos: $("estadoRecursos").value || null,
                observaciones: observacionesHidden.value
            };

            const audienciasInputs = audienciasContainer.querySelectorAll('.audiencia-fecha');
            datos.audiencias = [];
            audienciasInputs.forEach(input => {
                if (input.value) datos.audiencias.push(input.value);
            });

            const diligenciasItems = diligenciasContainer.querySelectorAll('.diligencia-item');
            datos.diligencias = [];
            diligenciasItems.forEach(item => {
                const fecha = item.querySelector('.diligencia-fecha').value;
                const detalle = item.querySelector('.diligencia-detalle').value.trim();
                if (fecha) {
                    datos.diligencias.push({ fecha, detalle });
                }
            });

            return datos;
        }

        function resetFormCausa() {
            $("formCausa").reset();
            observacionesEditor.innerHTML = '';
            observacionesHidden.value = '';
            audienciasContainer.innerHTML = '';
            diligenciasContainer.innerHTML = '';
            $("habilitarAudienciaGesell").checked = false;
            $("audienciaGesell").disabled = true;
            $("nnyaGesell").disabled = true;
            $("recursos-opcionales").style.display = 'none';
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons[0].classList.add('active');
            tabContents[0].classList.add('active');
            
            $("counter").textContent = '0/1000';
            $("counterNnya").textContent = '0/500';
            $("counterNnyaGesell").textContent = '0/400';
            
            document.querySelectorAll('.field').forEach(field => field.classList.remove('error'));
        }

        function cargarDatosEnForm(data) {
            $("numCausa").value = data.numCausa || '';
            $("caratula").value = data.caratula || '';
            $("tipoProceso").value = data.tipoProceso || '';
            poblarJuzgadosPorTipo(data.tipoProceso);
            setTimeout(() => { $("juzgado").value = data.juzgado || ''; }, 100);
            $("prioridad").value = data.prioridad || 'Ninguna';
            $("usuarioAsignado").value = data.usuarioAsignado || '';
            $("estado").value = data.estado || 'En trÃ¡mite';
            $("intervencion").value = data.intervencion || '';
            $("datosNnya").value = data.datosNnya || '';
            $("fechaInicio").value = data.fechaInicio ? formatFechaParaInput(toDate(data.fechaInicio), false) : '';
            $("fechaPase").value = data.fechaPase ? formatFechaParaInput(toDate(data.fechaPase), true) : '';
            $("vencimiento").value = data.vencimiento ? formatFechaParaInput(toDate(data.vencimiento), true) : '';
            $("vencimientoRecursos").value = data.vencimientoRecursos ? formatFechaParaInput(toDate(data.vencimientoRecursos), true) : '';
            $("recursos").value = data.recursos || '';
            $("recursosContestacion").value = data.recursosContestacion || '';
            $("estadoRecursos").value = data.estadoRecursos || '';
            observacionesEditor.innerHTML = data.observaciones || '';
            observacionesHidden.value = data.observaciones || '';
            
            audienciasContainer.innerHTML = '';
            if (Array.isArray(data.audiencias)) {
                data.audiencias.forEach(aud => {
                    const div = document.createElement('div');
                    div.className = 'audiencia-item';
                    div.innerHTML = `
                        <input type="datetime-local" class="audiencia-fecha" value="${formatFechaParaInput(toDate(aud), true)}">
                        <button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>
                    `;
                    audienciasContainer.appendChild(div);
                    div.querySelector('.btn-eliminar-audiencia').onclick = function() {
                        audienciasContainer.removeChild(div);
                    };
                });
            }
            
            diligenciasContainer.innerHTML = '';
            if (Array.isArray(data.diligencias)) {
                data.diligencias.forEach(dilig => {
                    const div = document.createElement('div');
                    div.className = 'diligencia-item';
                    div.innerHTML = `
                        <input type="datetime-local" class="diligencia-fecha" value="${formatFechaParaInput(toDate(dilig.fecha), true)}">
                        <input type="text" class="diligencia-detalle" placeholder="Detalle" value="${dilig.detalle || ''}">
                        <button type="button" class="btn-eliminar-diligencia"><i class="fa fa-trash"></i></button>
                    `;
                    diligenciasContainer.appendChild(div);
                    div.querySelector('.btn-eliminar-diligencia').onclick = function() {
                        diligenciasContainer.removeChild(div);
                    };
                });
            }
            
            if (data.audienciaGesell) {
                $("habilitarAudienciaGesell").checked = true;
                $("audienciaGesell").disabled = false;
                $("nnyaGesell").disabled = false;
                $("audienciaGesell").value = formatFechaParaInput(toDate(data.audienciaGesell), true);
                $("nnyaGesell").value = data.nnyaGesell || '';
            }
            
            if (data.recursos) {
                $("recursos-opcionales").style.display = 'block';
            }
            
            if (data.observaciones) {
                const palabrasObs = data.observaciones.trim().split(/\s+/).filter(p => p.length > 0);
                $("counter").textContent = `${palabrasObs.length}/1000`;
            }
            if (data.datosNnya) {
                const palabrasNnya = data.datosNnya.trim().split(/\s+/).filter(p => p.length > 0);
                $("counterNnya").textContent = `${palabrasNnya.length}/500`;
            }
            if (data.nnyaGesell) {
                const palabrasGesell = data.nnyaGesell.trim().split(/\s+/).filter(p => p.length > 0);
                $("counterNnyaGesell").textContent = `${palabrasGesell.length}/400`;
            }
        }
        
        function obtenerTodosEventos(causa) {
            const eventos = [];
            
            if (Array.isArray(causa.audiencias)) {
                causa.audiencias.forEach(aud => {
                    const fecha = toDate(aud);
                    if (fecha) {
                        eventos.push({ 
                            tipo: "Audiencia", 
                            fecha: fecha,
                            clase: "audiencia"
                        });
                    }
                });
            }
            
            if (causa.audienciaGesell) {
                const fecha = toDate(causa.audienciaGesell);
                if (fecha) {
                    eventos.push({ 
                        tipo: "Gesell", 
                        fecha: fecha,
                        clase: "gesell"
                    });
                }
            }
            
            if (causa.vencimiento) {
                const fecha = toDate(causa.vencimiento);
                if (fecha) {
                    eventos.push({ 
                        tipo: "Vencimiento", 
                        fecha: fecha,
                        clase: "vencimiento"
                    });
                }
            }
            
            if (causa.vencimientoRecursos) {
                const fecha = toDate(causa.vencimientoRecursos);
                if (fecha) {
                    eventos.push({ 
                        tipo: "Recurso", 
                        fecha: fecha,
                        clase: "recurso"
                    });
                }
            }
            
            if (Array.isArray(causa.diligencias)) {
                causa.diligencias.forEach(dilig => {
                    const fecha = toDate(dilig.fecha);
                    if (fecha) {
                        eventos.push({ 
                            tipo: "Diligencia", 
                            fecha: fecha,
                            detalle: dilig.detalle || '',
                            clase: "diligencia"
                        });
                    }
                });
            }
            
            eventos.sort((a, b) => b.fecha - a.fecha);
            return eventos;
        }
        
        async function cargarUsuarios() {
            try {
                if (!db) {
                    console.error("Firestore no estÃ¡ inicializado");
                    return;
                }
                console.log("Cargando usuarios...");
                const snapshot = await db.collection("usuarios").get();
                usuariosCache = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombreCompleto) {
                        usuariosCache.push(data.nombreCompleto);
                    }
                });
                usuariosCache.sort((a, b) => a.localeCompare(b));
                console.log("Usuarios cargados:", usuariosCache.length);
            } catch (e) {
                console.error("Error al cargar usuarios:", e);
                mostrarAlertaFlotante("Error al cargar usuarios: " + e.message, 'danger');
            }
        }
        
        async function cargarJuzgados() {
            try {
                if (!db) {
                    console.error("Firestore no estÃ¡ inicializado");
                    return;
                }
                console.log("Cargando juzgados...");
                const snapshot = await db.collection("juzgados").get();
                juzgadosPorTipoCache = {};
                snapshot.forEach(doc => {
                    const { tipo, nombre } = doc.data();
                    if (tipo && nombre) {
                        if (!juzgadosPorTipoCache[tipo]) {
                            juzgadosPorTipoCache[tipo] = [];
                        }
                        juzgadosPorTipoCache[tipo].push(nombre);
                    }
                });
                Object.keys(juzgadosPorTipoCache).forEach(tipo => {
                    juzgadosPorTipoCache[tipo].sort((a, b) => a.localeCompare(b));
                });
                console.log("Juzgados cargados:", Object.keys(juzgadosPorTipoCache).length);
            } catch (e) {
                console.error("Error al cargar juzgados:", e);
                mostrarAlertaFlotante("Error al cargar juzgados: " + e.message, 'danger');
            }
        }
        
        function poblarTiposProceso() {
            const selTipo = $("tipoProceso");
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            selTipo.innerHTML = '<option value="">Seleccione un tipo</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
        }
        
        function poblarFiltroTiposProceso() {
            const current = filtroTipoProceso.value;
            const tipos = Object.keys(juzgadosPorTipoCache).sort((a, b) => a.localeCompare(b));
            filtroTipoProceso.innerHTML = '<option value="">Tipo de Proceso (todos)</option>' + 
                tipos.map(t => `<option value="${t}">${t}</option>`).join('');
            if (current) filtroTipoProceso.value = current;
        }
        
        function poblarFiltroIntervencion() {
            const current = filtroIntervencion.value;
            filtroIntervencion.innerHTML = '<option value="">IntervenciÃ³n (todas)</option>' + 
                intervencionOptions.map(i => `<option value="${i}">${i}</option>`).join('');
            if (current) filtroIntervencion.value = current;
        }
        
        function poblarJuzgadosPorTipo(tipoSeleccionado) {
            const selJuz = $("juzgado");
            const juzgados = juzgadosPorTipoCache[tipoSeleccionado] || [];
            selJuz.innerHTML = '<option value="">Seleccione un juzgado</option>' + 
                juzgados.map(j => `<option value="${j}">${j}</option>`).join('');
        }
        
        function poblarSelectUsuarios() {
            const selUsu = $("usuarioAsignado");
            selUsu.innerHTML = '<option value="">Seleccione un usuario</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
        }
        
        function poblarFiltroUsuarios() {
            const current = filtroUsuario.value; 
            filtroUsuario.innerHTML = '<option value="">Usuario (todos)</option>' + 
                usuariosCache.map(u => `<option value="${u}">${u}</option>`).join('');
            if (current) filtroUsuario.value = current;
        }

        function suscribirCausas(reset = true) {
            if (reset) {
                paginaActual = 1;
            }
            if (!db) {
                console.error("Firestore no estÃ¡ inicializado");
                tbody.innerHTML = "<tr><td colspan='10'>Error: Base de datos no disponible</td></tr>";
                return;
            }
            
            if (unsubCausas) {
                console.log("Cancelando suscripciÃ³n anterior...");
                unsubCausas();
            }
            
            console.log("Construyendo consulta optimizada...");
            let query = db.collection("causas");
            
            const fEstado = filtroEstado.value;
            const fUsuario = filtroUsuario.value;
            const fPrioridad = filtroPrioridad.value;
            const fIntervencion = filtroIntervencion.value;
            const fTipoProceso = filtroTipoProceso.value;
            const fEvento = filtroEventos.value;
            const fDesde = filtroFechaDesde.value;
            const fHasta = filtroFechaHasta.value;
            const busqueda = buscador.value.trim();
            
            if (fEstado) query = query.where("estado", "==", fEstado);
            if (fUsuario) query = query.where("usuarioAsignado", "==", fUsuario);
            if (fPrioridad) query = query.where("prioridad", "==", fPrioridad);
            if (fIntervencion) query = query.where("intervencion", "==", fIntervencion);
            if (fTipoProceso) query = query.where("tipoProceso", "==", fTipoProceso);
            
            if (fEvento) {
                switch(fEvento) {
                    case 'audiencias': query = query.where("audiencias", "!=", null); break;
                    case 'gesell': query = query.where("audienciaGesell", "!=", null); break;
                    case 'vencimientos': query = query.where("vencimiento", "!=", null); break;
                    case 'recursos': query = query.where("vencimientoRecursos", "!=", null); break;
                    case 'diligencias': query = query.where("diligencias", "!=", null); break;
                }
            }
            
            if (busqueda) {
                const palabras = busqueda.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .split(/\s+/)
                    .filter(p => p.length > 0);
                
                if (palabras.length > 0) {
                    const palabrasLimitadas = palabras.slice(0, 10);
                    query = query.where("keywords", "array-contains-any", palabrasLimitadas);
                }
            }
            
            if (fDesde && fHasta && fDesde === fHasta) {
                query = query.where("fechasFiltro", "array-contains", fDesde);
            }
            
            query = query.orderBy("fechaRegistro", "desc");
            
            console.log("Suscribiendo a cambios optimizados...");
            unsubCausas = query.onSnapshot(
                snap => {
                    console.log("Datos recibidos del servidor:", snap.size, "registros");
                    datosCache = [];
                    snap.forEach(d => {
                        datosCache.push({ id: d.id, ...d.data() });
                    });
                    
                    datosFiltrados = datosCache.filter(d => {
                        if (fDesde && fHasta && fDesde !== fHasta) {
                            const fechasCausa = d.fechasFiltro || [];
                            const tieneFechaEnRango = fechasCausa.some(fecha => {
                                return fecha >= fDesde && fecha <= fHasta;
                            });
                            if (!tieneFechaEnRango) return false;
                        }
                        return true;
                    });
                    
                    renderTablaPaginada();
                },
                err => {
                    console.error("Error en onSnapshot optimizado:", err);
                    if (err.message.includes("index")) {
                        tbody.innerHTML = `<tr><td colspan='10' style='color:red;text-align:center;padding:20px'>
                            <strong>Falta Ãndice en Firebase.</strong><br>
                            <span style="font-size:0.9rem">Para solucionar, ejecuta en la consola del navegador (F12):</span><br>
                            <code style="background:#eee;padding:5px;margin:5px 0;display:inline-block">window.migrarDatosParaBusqueda()</code>
                        </td></tr>`;
                    } else {
                        tbody.innerHTML = `<tr><td colspan='10'>Error al cargar los datos: ${err.message}</td></tr>`;
                    }
                    mostrarAlertaFlotante("Error al cargar los expedientes: " + err.message, 'danger');
                }
            );
        }

        function actualizarFiltros() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                suscribirCausas(true);
            }, 500);
        }
        
        function renderTablaPaginada() {
            const startIndex = (paginaActual - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const dataToRender = datosFiltrados.slice(startIndex, endIndex);
            renderTablas(dataToRender);
            renderPaginacion(datosFiltrados.length, dataToRender.length);
        }
        
        function accionesHTML(id){
            return `<button class="button ver-detalles" data-id="${id}" title="Ver"><i class="fa fa-eye"></i></button>
                    <button class="button button-secondary editar-detalles" data-id="${id}" title="Editar"><i class="fa fa-pen"></i></button>`;
        }
        
        function renderTablas(data){
            tbody.innerHTML = data.length ? "" : "<tr><td colspan='10'>No hay registros que coincidan con los filtros</td></tr>";
            data.forEach(d=>{
                const todosEventos = obtenerTodosEventos(d);
                let eventosHTML = "â€”";
                if (todosEventos.length > 0) {
                    eventosHTML = `<div class="eventos-lista">`;
                    todosEventos.forEach(evento => {
                        let eventoTexto = `${evento.tipo}: ${formatearFecha(evento.fecha, true)}`;
                        if (evento.tipo === "Diligencia" && evento.detalle) {
                            eventoTexto += ` - ${evento.detalle}`;
                        }
                        eventosHTML += `<div class="evento-tabla ${evento.clase}">${eventoTexto}</div>`;
                    });
                    eventosHTML += `</div>`;
                }
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${d.numCausa||""}</td>
                        <td>${d.caratula||""}</td>
                        <td>${d.tipoProceso||""}</td>
                        <td>${d.juzgado||""}</td>
                        <td>${d.usuarioAsignado||""}</td>
                        <td>${d.estado||""}</td>
                        <td><span class="prioridad-pill ${prioridadClase(d.prioridad)}">${d.prioridad||"Ninguna"}</span></td>
                        <td>${formatearFecha(d.fechaRegistro, false)}</td>
                        <td>${eventosHTML}</td>
                        <td class="actions">${accionesHTML(d.id)}</td>
                    </tr>`);
            });
            document.querySelectorAll(".ver-detalles").forEach(b=>b.onclick=()=>abrirVer(b.dataset.id));
            document.querySelectorAll(".editar-detalles").forEach(b=>b.onclick=()=>abrirEditar(b.dataset.id));
        }
        
        function renderPaginacion(totalRecords, recordsOnPage) {
            const container = $("paginacion-container");
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            container.style.display = totalPages > 1 ? "flex" : "none";
            container.innerHTML = `
                <div class="page-info">
                    PÃ¡gina ${paginaActual} de ${totalPages} | Mostrando ${recordsOnPage} de ${totalRecords} registros
                </div>
                <div class="nav-buttons">
                    <button id="btnPrevPage" class="button" ${paginaActual === 1 ? 'disabled' : ''}><i class="fa fa-arrow-left"></i> Anterior</button>
                    <button id="btnNextPage" class="button" ${paginaActual === totalPages ? 'disabled' : ''}>Siguiente <i class="fa fa-arrow-right"></i></button>
                </div>
            `;
            if ($("btnPrevPage")) {
                $("btnPrevPage").onclick = () => {
                    paginaActual--;
                    renderTablaPaginada();
                };
            }
            if ($("btnNextPage")) {
                $("btnNextPage").onclick = () => {
                    paginaActual++;
                    renderTablaPaginada();
                };
            }
        }
        
        function renderEventosHoy() {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            
            const eventosHoy = {
                audiencias: [],
                gesell: [],
                vencimientos: [],
                recursos: [],
                diligencias: []
            };
            
            datosCache.forEach(d => {
                const id = d.numCausa || d.id;
                const causaId = d.id;
                if (Array.isArray(d.audiencias)) {
                    d.audiencias.forEach(aud => {
                        const fechaAud = toDate(aud);
                        if (fechaAud && fechaAud >= hoy && fechaAud < manana) {
                            eventosHoy.audiencias.push({
                                id: causaId,
                                numCausa: id,
                                fecha: fechaAud,
                                tipo: 'Audiencia'
                            });
                        }
                    });
                }
                const fechaGesell = toDate(d.audienciaGesell);
                if (fechaGesell && fechaGesell >= hoy && fechaGesell < manana) {
                    eventosHoy.gesell.push({
                                id: causaId,
                                numCausa: id,
                                fecha: fechaGesell,
                                tipo: 'CÃ¡mara Gesell'
                            });
                }
                const fechaVenc = toDate(d.vencimiento);
                if (fechaVenc && fechaVenc >= hoy && fechaVenc < manana) {
                    eventosHoy.vencimientos.push({
                                id: causaId,
                                numCausa: id,
                                fecha: fechaVenc,
                                tipo: 'Vencimiento'
                            });
                }
                const fechaVrec = toDate(d.vencimientoRecursos);
                if (fechaVrec && fechaVrec >= hoy && fechaVrec < manana) {
                    eventosHoy.recursos.push({
                                id: causaId,
                                numCausa: id,
                                fecha: fechaVrec,
                                tipo: 'Vencimiento de Recurso'
                            });
                }
                if (Array.isArray(d.diligencias)) {
                    d.diligencias.forEach(dilig => {
                        const fechaDilig = toDate(dilig.fecha);
                        if (fechaDilig && fechaDilig >= hoy && fechaDilig < manana) {
                            eventosHoy.diligencias.push({
                                id: causaId,
                                numCausa: id,
                                fecha: fechaDilig,
                                tipo: 'Diligencia',
                                detalle: dilig.detalle || ''
                            });
                        }
                    });
                }
            });
            
            const renderListaEventos = (eventos, target, tipo) => {
                target.innerHTML = "";
                if (!eventos.length) {
                    target.innerHTML = `<div class="evento-vacio">No hay eventos para hoy</div>`;
                    return;
                }
                eventos.sort((a, b) => a.fecha - b.fecha);
                eventos.forEach(evento => {
                    const elemento = document.createElement('div');
                    elemento.className = `evento-item evento-item-${tipo}`;
                    let contenido = `
                        <span class="evento-numero" data-id="${evento.id}">${evento.numCausa}</span>
                        <span class="evento-hora">${formatearFecha(evento.fecha, true)}</span>
                    `;
                    if (tipo === 'diligencias' && evento.detalle) {
                        contenido += `<span class="evento-detalle" style="font-size:0.8rem;color:var(--text-secondary);">${evento.detalle}</span>`;
                    }
                    elemento.innerHTML = contenido;
                    target.appendChild(elemento);
                    const numeroCausa = elemento.querySelector('.evento-numero');
                    numeroCausa.onclick = (e) => {
                        e.preventDefault();
                        abrirVer(evento.id);
                    };
                });
            };
            
            renderListaEventos(eventosHoy.audiencias, listAudHoy, 'audiencias');
            renderListaEventos(eventosHoy.gesell, listGesellHoy, 'gesell');
            renderListaEventos(eventosHoy.vencimientos, listVencHoy, 'vencimientos');
            renderListaEventos(eventosHoy.recursos, listRecursosHoy, 'recursos');
            renderListaEventos(eventosHoy.diligencias, listDiligenciasHoy, 'diligencias');
        }
        
        function abrirNuevoExpediente() {
            modo = "nuevo"; 
            resetFormCausa(); 
            editId.value = ""; 
            tituloForm.textContent = "Nuevo Expediente"; 
            
            deshabilitarCamposFormulario(false);
            
            modal.style.display = "flex"; 
        }
        
        function validateForm() {
            let isValid = true;
            const requiredFields = ["numCausa", "caratula", "tipoProceso", "juzgado", "prioridad", "usuarioAsignado"];
            
            requiredFields.forEach(id => {
                const field = $(id);
                const parent = field.closest('.field');
                if (field.value.trim() === "") {
                    parent.classList.add('error');
                    isValid = false;
                } else {
                    parent.classList.remove('error');
                }
            });
            
            if (!isValid) {
                mostrarAlertaFlotante("Complete todos los campos obligatorios marcados con *", 'danger');
                return false;
            }
            
            return isValid;
        }
        
        const mostrarAlertaPersonalizada = (titulo, mensaje) => {
            alertTitle.textContent = titulo;
            alertMessage.textContent = mensaje;
            alertModal.style.display = "flex";
        };
        
        btnAlertOK.onclick = () => {
            alertModal.style.display = "none";
        };
        
        const guardarExpediente = async () => {
            if (!validateForm()) {
                return;
            }
            
            if (modo === "nuevo") {
                const numCausa = $("numCausa").value.trim();
                const existe = datosCache.some(causa => causa.numCausa === numCausa);
                
                if (existe) {
                    mostrarAlertaFlotante("No se puede guardar: El nÃºmero de expediente ya estÃ¡ registrado en el sistema.", 'danger');
                    
                    const numCausaField = $("numCausa").closest('.field');
                    numCausaField.classList.add('error');
                    const errorSpan = numCausaField.querySelector('.error-message');
                    errorSpan.textContent = "Este nÃºmero de expediente ya estÃ¡ registrado";
                    errorSpan.style.color = "#dc3545";
                    errorSpan.style.fontWeight = "bold";
                    
                    $("numCausa").scrollIntoView({ behavior: 'smooth', block: 'center' });
                    $("numCausa").focus();
                    
                    return;
                }
            }
            
            if (!db) {
                mostrarAlertaFlotante("Error: Base de datos no disponible", 'danger');
                return;
            }
            
            const datos = recolectarDatosForm();
            const btnGuardar = $("btnGuardar");
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            try {
                const textoParaKeywords = [datos.numCausa, datos.caratula, datos.usuarioAsignado]
                    .join(' ')
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^\w\s]/gi, '')
                    .split(/\s+/)
                    .filter(palabra => palabra.length > 0);
                datos.keywords = textoParaKeywords;
                
                const fechasSet = new Set();
                const agregarFecha = (fecha) => {
                    if (!fecha) return;
                    const d = toDate(fecha);
                    if (d && !isNaN(d)) {
                        fechasSet.add(formatFechaParaInput(d, false));
                    }
                };
                
                agregarFecha(datos.vencimiento);
                agregarFecha(datos.vencimientoRecursos);
                agregarFecha(datos.audienciaGesell);
                if (Array.isArray(datos.audiencias)) {
                    datos.audiencias.forEach(agregarFecha);
                }
                if (Array.isArray(datos.diligencias)) {
                    datos.diligencias.forEach(dilig => agregarFecha(dilig.fecha));
                }
                
                datos.fechasFiltro = Array.from(fechasSet);
                
                if (modo === "nuevo") {
                    const dupCheck = await db.collection("causas").where("numCausa", "==", $("numCausa").value.trim()).get();
                    if (!dupCheck.empty) {
                        mostrarAlertaFlotante("El NÂ° Expediente ya existe en la base de datos.", 'danger');
                        $("numCausa").closest('.field').classList.add('error');
                        const errorSpan = $("numCausa").closest('.field').querySelector('.error-message');
                        errorSpan.textContent = "Este nÃºmero de expediente ya estÃ¡ registrado en el servidor";
                        errorSpan.style.color = "#dc3545";
                        errorSpan.style.fontWeight = "bold";
                        return;
                    }
                    
                    await db.collection("causas").add({
                        ...datos, 
                        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    mostrarAlertaFlotante("Se guardÃ³ correctamente el expediente.", 'success');
                } else {
                    await db.collection("causas").doc(editId.value).update(datos);
                    mostrarAlertaFlotante("El registro fue correctamente actualizado.", 'success');
                }
                modal.style.display = "none";
                resetFormCausa();
                suscribirCausas(true);
            } catch (e) {
                console.error(e);
                if (modo === "nuevo") {
                    mostrarAlertaFlotante("Fallo al crear el registro: " + e.message, 'danger');
                } else {
                    mostrarAlertaFlotante("Fallo de actualizaciÃ³n del registro: " + e.message, 'danger');
                }
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="fa fa-save"></i> Guardar';
            }
        };
        
        async function abrirEditar(id){
            modo = "editar"; 
            resetFormCausa();
            editId.value = id; 
            tituloForm.textContent = "Editar Expediente";
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (snap.exists){
                    cargarDatosEnForm(snap.data());
                    modal.style.display = "flex"; 
                } else {
                    mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
                }
            }catch(e){ 
                console.error(e); 
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el registro: " + e.message); 
            }
        }
        
        async function abrirVer(id){
            causaActualId = id;
            try{
                const snap = await db.collection("causas").doc(id).get();
                if (!snap.exists) {
                    mostrarAlertaPersonalizada("Error", "El expediente no fue encontrado.");
                    return;
                }
                const d = snap.data();
                let contenidoHTML = "";
                const prioridadClaseTextoVal = prioridadClaseTexto(d.prioridad);
                const prioridadTexto = `<div class="prioridad-texto ${prioridadClaseTextoVal}"><strong>Prioridad: ${d.prioridad || "Ninguna"}</strong></div>`;
                contenidoHTML += prioridadTexto;
                const etiquetas = {
                    numCausa: "NÂ° Expediente", caratula: "CarÃ¡tula", tipoProceso: "Tipo de Proceso", juzgado: "Juzgado",
                    fechaInicio: "Fecha de Inicio", fechaPase: "Fecha de Pase", intervencion: "IntervenciÃ³n",
                    datosNnya: "Datos de NNyA", vencimiento: "Vencimiento", usuarioAsignado: "Usuario Asignado",
                    estado: "Estado", recursos: "Recursos Interpuestos",
                    recursosContestacion: "ContestaciÃ³n de Recursos", estadoRecursos: "Estado de Recursos",
                    vencimientoRecursos: "Vencimiento de Recursos", audienciaGesell: "Audiencia Gesell",
                    nnyaGesell: "NNyA en Gesell", observaciones: "Observaciones", fechaRegistro: "Fecha de Registro"
                };
                const ordenClaves = [
                    "numCausa", "caratula", "tipoProceso", "juzgado", "estado", "usuarioAsignado",
                    "fechaRegistro", "fechaInicio", "fechaPase", "intervencion", "datosNnya", "vencimiento",
                    "audiencias", "diligencias", "recursos", "recursosContestacion", "estadoRecursos", "vencimientoRecursos",
                    "audienciaGesell", "nnyaGesell", "observaciones"
                ];
                ordenClaves.forEach(k => {
                    const v = d[k];
                    if (v !== null && v !== undefined && v !== "" && k !== "prioridad") {
                        const etiqueta = etiquetas[k] || k;
                        if (k === "audiencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Audiencias:</strong></p>`;
                            v.forEach(aud => {
                                contenidoHTML += `<p style="margin-left: 20px;">${formatearFecha(aud, true)}</p>`;
                            });
                        } else if (k === "diligencias" && Array.isArray(v) && v.length > 0) {
                            contenidoHTML += `<p><strong>Diligencias:</strong></p>`;
                            v.forEach(dilig => {
                                const fecha = formatearFecha(dilig.fecha, true);
                                const detalle = dilig.detalle ? ` - ${dilig.detalle}` : '';
                                contenidoHTML += `<p style="margin-left: 20px;">${fecha}${detalle}</p>`;
                            });
                        } else if (['fechaInicio', 'fechaRegistro'].includes(k)) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, false)}</p>`;
                        } else if (v.seconds) {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${formatearFecha(v, true)}</p>`;
                        } else if (k === "observaciones") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong></p><div>${v}</div>`;
                        } else if (k !== "audiencias" && k !== "diligencias") {
                            contenidoHTML += `<p><strong>${etiqueta}:</strong> ${v}</p>`;
                        }
                    }
                });
                verContenido.innerHTML = contenidoHTML;
                await cargarNotas(id);
                modalVer.style.display = "flex";
            } catch(e) {
                console.error(e);
                mostrarAlertaPersonalizada("Error", "No se pudo abrir el detalle: " + e.message);
            }
        }
        
        async function cargarNotas(causaId) {
            historialNotas.innerHTML = "Cargando notas...";
            try {
                const snapshot = await db.collection("causas").doc(causaId).collection("seguimiento").orderBy("fecha", "desc").get();
                if (snapshot.empty) {
                    historialNotas.innerHTML = `<p class="k">No hay notas de seguimiento.</p>`;
                    return;
                }
                historialNotas.innerHTML = "";
                snapshot.forEach(doc => {
                    const nota = doc.data();
                    const fecha = formatearFecha(nota.fecha, true);
                    const notaHTML = `
                        <div class="note-item">
                        <div class="note-meta">
                            <span>${fecha}</span>
                            <span>por: ${nota.usuario || "AnÃ³nimo"}</span>
                        </div>
                        <div class="note-text">${nota.texto}</div>
                        </div>
                    `;
                    historialNotas.insertAdjacentHTML("beforeend", notaHTML);
                });
            } catch(e) {
                console.error("Error al cargar notas:", e);
                historialNotas.innerHTML = `<p class="k">Error al cargar notas: ${e.message}</p>`;
            }
        }
        
        async function agregarNota() {
            if (!causaActualId) return mostrarAlertaPersonalizada("Error", "No se ha seleccionado una causa.");
            const notaTexto = notaBitacora.value.trim();
            if (!notaTexto) return mostrarAlertaPersonalizada("Error", "Por favor, escribe un texto para la nota.");
            const usuario = "Usuario Actual"; 
            try {
                await db.collection("causas").doc(causaActualId).collection("seguimiento").add({
                    texto: notaTexto, fecha: firebase.firestore.FieldValue.serverTimestamp(), usuario: usuario
                });
                notaBitacora.value = "";
                cargarNotas(causaActualId);
                mostrarAlertaPersonalizada("Â¡Ã‰xito!", "Nota guardada con Ã©xito.");
            } catch (e) {
                console.error("Error al guardar la nota:", e);
                mostrarAlertaPersonalizada("Error", "No se pudo guardar la nota: " + e.message);
            }
        }
        
        btnAgregarNota.onclick = agregarNota;
        $("btnCerrarVer").onclick = ()=> modalVer.style.display = "none";
        $("btnCerrarEventosHoy").onclick = ()=> modalEventosHoy.style.display = "none";
        
        // ======================================================================
        // NUEVO ASISTENTE IA - PANTALLA COMPLETA CON VOZ
        // ======================================================================
        
        let conversacionIA = [];
        let vozReconocimiento = null;
        let vozReconocimientoActivo = false;
        let textToSpeechActivo = false;
        
        function abrirAsistenteIA() {
            modalIA.style.display = "flex";
            iaPregunta.focus();
            
            // Limpiar conversaciÃ³n inicial (sin mensaje de bienvenida)
            iaConversacion.innerHTML = "";
            
            // Agregar un mensaje inicial simple
            agregarMensajeIA("asistente", 
                `<strong>Asistente IA de Expedientes</strong><br>
                Puedo ayudarte a buscar y analizar expedientes judiciales. Â¿En quÃ© puedo asistirte?`);
            
            generarChipsSugerencias();
        }
        
        function cerrarAsistenteIA() {
            modalIA.style.display = "none";
            // Detener reconocimiento de voz si estÃ¡ activo
            if (vozReconocimientoActivo) {
                detenerVozReconocimiento();
            }
            // Detener sÃ­ntesis de voz
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }
        
        function nuevaConsultaIA() {
            iaConversacion.innerHTML = "";
            iaPregunta.value = "";
            ultimoResultadoIA = [];
            contextoActivo = false;
            
            agregarMensajeIA("asistente", 
                `<strong>Consulta Nueva</strong><br>
                Â¿QuÃ© deseas buscar o analizar en los expedientes?`);
                
            generarChipsSugerencias();
            iaPregunta.focus();
        }
        
        function generarChipsSugerencias() {
            const chips = [
                { texto: "ðŸ“… Vencimientos esta semana", query: "vencimientos esta semana", clase: "vencimientos" },
                { texto: "ðŸš¨ Prioridad Alta", query: "prioridad alta", clase: "prioridad-alta" },
                { texto: "ðŸ“Š EstadÃ­sticas completas", query: "estadÃ­sticas completas", clase: "estadisticas" },
                { texto: "âš–ï¸ En trÃ¡mite", query: "expedientes en trÃ¡mite", clase: "" },
                { texto: "ðŸ‘¤ Mis expedientes", query: "mis expedientes", clase: "" },
                { texto: "ðŸ“ Por tipo penal", query: "expedientes de tipo penal", clase: "" }
            ];
            
            iaChipsContainer.innerHTML = chips.map(chip => `
                <button class="ia-chip ${chip.clase}" data-query="${chip.query}">
                    <i class="fas fa-${chip.texto.includes('EstadÃ­sticas') ? 'chart-bar' : chip.texto.includes('Prioridad') ? 'exclamation-triangle' : chip.texto.includes('Vencimientos') ? 'calendar' : chip.texto.includes('Mis') ? 'folder' : chip.texto.includes('trÃ¡mite') ? 'balance-scale' : 'user'}"></i>
                    ${chip.texto}
                </button>
            `).join('');
            
            document.querySelectorAll('.ia-chip').forEach(chip => {
                chip.onclick = function() {
                    iaPregunta.value = this.dataset.query;
                    enviarPreguntaIA();
                };
            });
        }
        
        async function enviarPreguntaIA() {
            const pregunta = iaPregunta.value.trim();
            if (!pregunta) return;
            
            iaPregunta.value = "";
            agregarMensajeIA("usuario", pregunta);
            
            // Simular "pensando"
            const mensajeCarga = agregarMensajeCarga();
            
            // PequeÃ±o delay para UX
            setTimeout(() => {
                mensajeCarga.remove();
                procesarConsultaInteligente(pregunta);
            }, 800);
        }
        
        // FUNCIÃ“N PARA SINTETIZAR VOZ (TEXT-TO-SPEECH) MEJORADA
        function sintetizarVoz(texto, elementoBtn = null) {
            if (!('speechSynthesis' in window)) {
                console.warn("Text-to-speech no soportado en este navegador");
                return;
            }
            
            // Cancelar cualquier sÃ­ntesis en curso
            speechSynthesis.cancel();
            textToSpeechActivo = true;
            
            // Si hay un botÃ³n, marcarlo como activo
            if (elementoBtn) {
                elementoBtn.classList.add('speaking');
            }
            
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'es-ES';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 0.8;
            
            // Seleccionar voz
            const voces = speechSynthesis.getVoices();
            const vozFemenina = voces.find(voz => voz.lang === 'es-ES' && voz.name.includes('Female'));
            const vozEspanol = voces.find(voz => voz.lang === 'es-ES');
            
            if (vozFemenina) {
                utterance.voice = vozFemenina;
            } else if (vozEspanol) {
                utterance.voice = vozEspanol;
            }
            
            utterance.onstart = function() {
                console.log("Comenzando sÃ­ntesis de voz...");
            };
            
            utterance.onend = function() {
                console.log("SÃ­ntesis de voz finalizada");
                textToSpeechActivo = false;
                if (elementoBtn) {
                    elementoBtn.classList.remove('speaking');
                }
            };
            
            utterance.onerror = function(event) {
                console.error("Error en sÃ­ntesis de voz:", event);
                textToSpeechActivo = false;
                if (elementoBtn) {
                    elementoBtn.classList.remove('speaking');
                }
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // FUNCIÃ“N PARA RECONOCIMIENTO DE VOZ (VOZ A TEXTO)
        function iniciarVozReconocimiento() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                mostrarAlertaFlotante("El reconocimiento de voz no es compatible con este navegador.", 'danger');
                return;
            }
            
            if (vozReconocimientoActivo) {
                detenerVozReconocimiento();
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            vozReconocimiento = new SpeechRecognition();
            vozReconocimiento.lang = 'es-ES';
            vozReconocimiento.interimResults = false;
            vozReconocimiento.continuous = false;
            vozReconocimiento.maxAlternatives = 1;
            
            vozReconocimiento.onstart = function() {
                vozReconocimientoActivo = true;
                btnVoiceIA.classList.add('listening');
                mostrarAlertaFlotante("Escuchando... Habla ahora", 'info');
            };
            
            vozReconocimiento.onresult = function(event) {
                const transcripcion = event.results[0][0].transcript;
                iaPregunta.value = transcripcion;
                // Opcional: enviar automÃ¡ticamente
                // enviarPreguntaIA();
            };
            
            vozReconocimiento.onerror = function(event) {
                console.error("Error en reconocimiento de voz:", event.error);
                if (event.error === 'no-speech') {
                    mostrarAlertaFlotante("No se detectÃ³ voz. Intenta nuevamente.", 'warning');
                } else if (event.error === 'audio-capture') {
                    mostrarAlertaFlotante("No se pudo acceder al micrÃ³fono.", 'danger');
                } else if (event.error === 'not-allowed') {
                    mostrarAlertaFlotante("Permiso para micrÃ³fono denegado.", 'danger');
                }
                vozReconocimientoActivo = false;
                btnVoiceIA.classList.remove('listening');
            };
            
            vozReconocimiento.onend = function() {
                vozReconocimientoActivo = false;
                btnVoiceIA.classList.remove('listening');
            };
            
            vozReconocimiento.start();
        }
        
        function detenerVozReconocimiento() {
            if (vozReconocimiento) {
                vozReconocimiento.stop();
            }
            vozReconocimientoActivo = false;
            btnVoiceIA.classList.remove('listening');
        }
        
        // FUNCIÃ“N MEJORADA PARA FECHAS RELATIVAS
        function obtenerRangoFechasRelativas(expresion) {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            
            const semanaPasadaInicio = new Date(hoy);
            semanaPasadaInicio.setDate(semanaPasadaInicio.getDate() - 7);
            
            const semanaProximaFin = new Date(hoy);
            semanaProximaFin.setDate(semanaProximaFin.getDate() + 7);
            
            const mesPasadoInicio = new Date(hoy);
            mesPasadoInicio.setMonth(mesPasadoInicio.getMonth() - 1);
            
            const mesProximoFin = new Date(hoy);
            mesProximoFin.setMonth(mesProximoFin.getMonth() + 1);
            
            const expresionLower = expresion.toLowerCase();
            
            if (expresionLower.includes("hoy")) {
                return { desde: formatFechaParaInput(hoy, false), hasta: formatFechaParaInput(hoy, false) };
            }
            if (expresionLower.includes("maÃ±ana")) {
                return { desde: formatFechaParaInput(manana, false), hasta: formatFechaParaInput(manana, false) };
            }
            if (expresionLower.includes("semana") && expresionLower.includes("pasada")) {
                return { desde: formatFechaParaInput(semanaPasadaInicio, false), hasta: formatFechaParaInput(hoy, false) };
            }
            if (expresionLower.includes("semana") && (expresionLower.includes("prÃ³xima") || expresionLower.includes("proxima") || expresionLower.includes("esta"))) {
                return { desde: formatFechaParaInput(hoy, false), hasta: formatFechaParaInput(semanaProximaFin, false) };
            }
            if (expresionLower.includes("mes") && expresionLower.includes("pasado")) {
                return { desde: formatFechaParaInput(mesPasadoInicio, false), hasta: formatFechaParaInput(hoy, false) };
            }
            if (expresionLower.includes("mes") && (expresionLower.includes("prÃ³ximo") || expresionLower.includes("proximo") || expresionLower.includes("este"))) {
                return { desde: formatFechaParaInput(hoy, false), hasta: formatFechaParaInput(mesProximoFin, false) };
            }
            
            return null;
        }
        
        // FUNCIÃ“N MEJORADA PARA BUSCAR EN REGISTROS
        function buscarEnRegistrosMejorado(tokens, contextoAnterior = null, tieneNegacion = false, rangoFechas = null) {
            const datosABuscar = contextoAnterior && contextoAnterior.length > 0 ? contextoAnterior : datosCache;
            const resultadosConPuntaje = [];
            
            datosABuscar.forEach(causa => {
                let score = 0;
                let coincidencias = [];
                let penalizacion = 0;
                
                // Normalizar textos para bÃºsqueda
                const campos = {
                    numCausa: (causa.numCausa || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    caratula: (causa.caratula || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    usuario: (causa.usuarioAsignado || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    tipo: (causa.tipoProceso || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    juzgado: (causa.juzgado || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    estado: (causa.estado || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    prioridad: (causa.prioridad || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""),
                    intervencion: (causa.intervencion || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                };
                
                // Verificar filtro por fechas relativas
                if (rangoFechas) {
                    const fechasCausa = causa.fechasFiltro || [];
                    const tieneFechaEnRango = fechasCausa.some(fecha => {
                        return fecha >= rangoFechas.desde && fecha <= rangoFechas.hasta;
                    });
                    if (!tieneFechaEnRango) {
                        score -= 100;
                    } else {
                        score += 20;
                    }
                }
                
                tokens.forEach(token => {
                    const esNegacion = token.startsWith("no_") || token.startsWith("sin_");
                    const tokenLimpio = esNegacion ? token.substring(3) : token;
                    
                    // Puntos por campo
                    if (campos.numCausa.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 50;
                        } else {
                            score += 10;
                            coincidencias.push(`NÂ°: ${causa.numCausa}`);
                        }
                    }
                    
                    if (campos.caratula.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 30;
                        } else {
                            score += 8;
                            coincidencias.push(`CarÃ¡tula: ${causa.caratula.substring(0, 50)}...`);
                        }
                    }
                    
                    if (campos.usuario.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 25;
                        } else {
                            score += 7;
                            coincidencias.push(`Usuario: ${causa.usuarioAsignado}`);
                        }
                    }
                    
                    if (campos.tipo.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 20;
                        } else {
                            score += 5;
                            coincidencias.push(`Tipo: ${causa.tipoProceso}`);
                        }
                    }
                    
                    if (campos.juzgado.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 20;
                        } else {
                            score += 5;
                            coincidencias.push(`Juzgado: ${causa.juzgado}`);
                        }
                    }
                    
                    if (campos.estado.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 15;
                        } else {
                            score += 4;
                            coincidencias.push(`Estado: ${causa.estado}`);
                        }
                    }
                    
                    if (campos.prioridad.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 15;
                        } else {
                            score += 6;
                            coincidencias.push(`Prioridad: ${causa.prioridad}`);
                        }
                    }
                    
                    if (campos.intervencion.includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 10;
                        } else {
                            score += 3;
                            coincidencias.push(`IntervenciÃ³n: ${causa.intervencion}`);
                        }
                    }
                    
                    // BÃºsqueda en observaciones
                    if (causa.observaciones && causa.observaciones.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(tokenLimpio)) {
                        if (esNegacion) {
                            penalizacion += 5;
                        } else {
                            score += 2;
                            coincidencias.push(`Observaciones: contiene "${tokenLimpio}"`);
                        }
                    }
                    
                    // DetecciÃ³n especial para "Vencimientos"
                    if (tokenLimpio === "vencimiento" || tokenLimpio === "vencimientos" || tokenLimpio === "vencer") {
                        if (causa.vencimiento) {
                            const hoy = new Date();
                            const fechaVenc = toDate(causa.vencimiento);
                            if (fechaVenc > hoy) {
                                score += 15;
                                coincidencias.push("Tiene vencimiento futuro");
                            } else if (fechaVenc < hoy) {
                                score += 5;
                                coincidencias.push("Tiene vencimiento pasado");
                            }
                        }
                    }
                });
                
                // Aplicar penalizaciÃ³n por negaciÃ³n
                if (tieneNegacion) {
                    score -= penalizacion;
                }
                
                // Penalizar si no hay suficientes coincidencias
                if (coincidencias.length < tokens.length * 0.3) {
                    score -= 10;
                }
                
                // Bonus por prioridad alta
                if (causa.prioridad === "Alta") {
                    score += 3;
                }
                
                if (score > 0) {
                    resultadosConPuntaje.push({
                        causa,
                        score,
                        coincidencias: [...new Set(coincidencias)].slice(0, 3)
                    });
                }
            });
            
            // Ordenar por puntaje
            return resultadosConPuntaje
                .sort((a, b) => b.score - a.score)
                .slice(0, 15)
                .map(item => item.causa);
        }
        
        function procesarConsultaInteligente(pregunta) {
            const texto = pregunta.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            // DETECCIÃ“N DE REFINAMIENTO
            const palabrasRefinamiento = ["filtrar", "solo", "solamente", "Ãºnicamente", "unicamente", "de estos", "entre estos", "dentro de"];
            const esRefinamiento = palabrasRefinamiento.some(p => texto.includes(p)) && ultimoResultadoIA.length > 0;
            
            // DETECCIÃ“N DE NEGACIÃ“N
            const tieneNegacion = texto.includes(" no ") || texto.includes(" sin ") || texto.startsWith("no ") || texto.startsWith("sin ");
            
            // DETECCIÃ“N DE FECHAS RELATIVAS
            const rangoFechas = obtenerRangoFechasRelativas(texto);
            
            // PROCESAR TOKENS
            const stopWords = ["de", "el", "la", "los", "las", "en", "y", "o", "que", "un", "una", "expediente", "expedientes", "causa", "causas", "buscar", "muestrame", "dime", "quiero", "ver", "mostrar"];
            let tokens = texto.split(/\s+/).filter(w => w.length > 2 && !stopWords.includes(w));
            
            // Procesar negaciones
            tokens = tokens.map(token => {
                if (token.startsWith("no") && token.length > 4) {
                    return `no_${token.substring(2)}`;
                }
                if (token.startsWith("sin") && token.length > 4) {
                    return `sin_${token.substring(3)}`;
                }
                return token;
            });
            
            if (tokens.length === 0 && !rangoFechas) {
                agregarMensajeIA("asistente", "Por favor, sÃ© un poco mÃ¡s especÃ­fico con tu bÃºsqueda.");
                return;
            }
            
            // DETECCIÃ“N DE ESTADÃSTICAS
            const palabrasEstadistica = ["estadistica", "estadÃ­sticas", "resumen", "total", "cuantos", "cuÃ¡ntos", "cuantas", "cuÃ¡ntas", "grafico", "grÃ¡fico", "analisis", "anÃ¡lisis", "conteo"];
            const esEstadistica = palabrasEstadistica.some(p => texto.includes(p));
            
            if (esEstadistica && !esRefinamiento) {
                const respuesta = generarEstadisticasIA();
                agregarMensajeIA("asistente", respuesta);
                // Sintetizar voz para estadÃ­sticas
                sintetizarVoz(`EncontrÃ© ${datosCache.length} expedientes en total. ${generarResumenEstadistico()}`);
                return;
            }
            
            // REALIZAR BÃšSQUEDA
            const datosABuscar = esRefinamiento ? ultimoResultadoIA : datosCache;
            const resultados = buscarEnRegistrosMejorado(tokens, datosABuscar, tieneNegacion, rangoFechas);
            
            // Guardar en memoria de contexto si no es refinamiento
            if (!esRefinamiento) {
                ultimoResultadoIA = resultados;
                contextoActivo = true;
            }
            
            if (resultados.length > 0) {
                const respuestaHTML = generarHTMLResultados(resultados, tokens, esRefinamiento, tieneNegacion, rangoFechas);
                agregarMensajeIA("asistente", `EncontrÃ© <strong>${resultados.length}</strong> expedientes que coinciden con tu bÃºsqueda:<br><br>${respuestaHTML}`);
                
                // Sintetizar voz para anunciar resultados
                sintetizarVoz(`EncontrÃ© ${resultados.length} expedientes que coinciden con tu bÃºsqueda.`);
                
                // Reactivar listeners para los botones "Ver" y "Voz"
                setTimeout(() => {
                    document.querySelectorAll('.ia-ver-causa').forEach(btn => {
                        btn.onclick = (e) => {
                            const id = e.currentTarget.dataset.id;
                            modalIA.style.display = "none";
                            abrirVer(id);
                        };
                    });
                }, 100);
            } else {
                agregarMensajeIA("asistente", `No encontrÃ© expedientes que coincidan con "<em>${pregunta}</em>". Intenta con otros tÃ©rminos o verifica la ortografÃ­a.`);
                sintetizarVoz("No encontrÃ© expedientes que coincidan con tu bÃºsqueda.");
                ultimoResultadoIA = [];
                contextoActivo = false;
            }
        }
        
        function generarHTMLResultados(listaCausas, tokensResaltar, esRefinamiento = false, tieneNegacion = false, rangoFechas = null) {
            let html = "";
            
            if (esRefinamiento) {
                html += `<p><small><i class="fas fa-filter"></i> Filtrado sobre resultados anteriores</small></p>`;
            }
            if (tieneNegacion) {
                html += `<p><small><i class="fas fa-ban"></i> Excluyendo tÃ©rminos especÃ­ficos</small></p>`;
            }
            if (rangoFechas) {
                html += `<p><small><i class="fas fa-calendar"></i> PerÃ­odo: ${rangoFechas.desde} a ${rangoFechas.hasta}</small></p>`;
            }
            
            listaCausas.forEach(causa => {
                const icono = causa.prioridad === "Alta" ? "ðŸ”´" : (causa.prioridad === "Media" ? "ðŸŸ " : "ðŸ”µ");
                
                // Resaltar coincidencias en carÃ¡tula
                let caratulaHTML = causa.caratula || "Sin carÃ¡tula";
                if (tokensResaltar && tokensResaltar.length > 0) {
                    tokensResaltar.forEach(token => {
                        const tokenLimpio = token.replace(/^(no_|sin_)/, '');
                        const regex = new RegExp(`(${tokenLimpio})`, 'gi');
                        caratulaHTML = caratulaHTML.replace(regex, '<span class="ia-highlight">$1</span>');
                    });
                }
                
                html += `
                <div class="ia-resultado-card ia-ver-causa" data-id="${causa.id}">
                    <div class="ia-card-header">
                        <span>${icono} ${causa.numCausa}</span>
                        <span>${causa.estado}</span>
                    </div>
                    <div class="ia-card-title">${caratulaHTML}</div>
                    <div class="ia-card-body">
                        <small>ðŸ‘¤ ${causa.usuarioAsignado || "Sin asignar"} | ðŸ›ï¸ ${causa.juzgado || ""} | ðŸ“… ${formatearFecha(causa.fechaRegistro, false)}</small>
                    </div>
                </div>`;
            });
            return html;
        }
        
        function generarEstadisticasIA() {
            const total = datosCache.length;
            const porEstado = {};
            const porUsuario = {};
            const porPrioridad = { Alta: 0, Media: 0, Baja: 0, Ninguna: 0 };
            const porTipo = {};
            
            datosCache.forEach(c => {
                porEstado[c.estado] = (porEstado[c.estado] || 0) + 1;
                porUsuario[c.usuarioAsignado] = (porUsuario[c.usuarioAsignado] || 0) + 1;
                porPrioridad[c.prioridad] = (porPrioridad[c.prioridad] || 0) + 1;
                porTipo[c.tipoProceso] = (porTipo[c.tipoProceso] || 0) + 1;
            });

            // Ordenar usuarios
            const topUsuarios = Object.entries(porUsuario).sort((a,b) => b[1] - a[1]).slice(0,5);
            let usuariosHTML = topUsuarios.map(u => `<li>${u[0]}: <strong>${u[1]}</strong></li>`).join("");
            
            // Ordenar tipos
            const topTipos = Object.entries(porTipo).sort((a,b) => b[1] - a[1]).slice(0,5);
            let tiposHTML = topTipos.map(t => `<li>${t[0]}: <strong>${t[1]}</strong></li>`).join("");

            return `
                <div class="ia-analisis-detallado">
                    <h4>ðŸ“Š Resumen EstadÃ­stico</h4>
                    <p>Total expedientes: <strong>${total}</strong></p>
                    
                    <strong>Por Prioridad:</strong>
                    <ul>
                        <li>Alta: <strong>${porPrioridad.Alta}</strong></li>
                        <li>Media: <strong>${porPrioridad.Media}</strong></li>
                        <li>Baja: <strong>${porPrioridad.Baja}</strong></li>
                        <li>Ninguna: <strong>${porPrioridad.Ninguna}</strong></li>
                    </ul>
                    
                    <strong>Por Estado:</strong>
                    <ul>
                        ${Object.keys(porEstado).map(k => `<li>${k}: <strong>${porEstado[k]}</strong></li>`).join("")}
                    </ul>
                    
                    <strong>Top 5 Usuarios:</strong>
                    <ul>${usuariosHTML}</ul>
                    
                    <strong>Top 5 Tipos:</strong>
                    <ul>${tiposHTML}</ul>
                </div>
            `;
        }
        
        function generarResumenEstadistico() {
            const total = datosCache.length;
            const alta = datosCache.filter(c => c.prioridad === "Alta").length;
            const enTramite = datosCache.filter(c => c.estado === "En trÃ¡mite").length;
            
            return `Hay ${alta} expedientes con prioridad alta y ${enTramite} en trÃ¡mite.`;
        }
        
        function agregarMensajeIA(rol, contenido) {
            const div = document.createElement('div');
            div.className = `ia-mensaje ${rol}`;
            
            if (rol === 'asistente') {
                // Generar un ID Ãºnico para este mensaje
                const mensajeId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                div.innerHTML = `
                    <div class="ia-mensaje-header">
                        <strong>ðŸ¤– Asistente IA</strong>
                        <div class="ia-mensaje-acciones">
                            <button class="ia-btn-voz" data-mensaje-id="${mensajeId}" title="Escuchar respuesta">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                    <div id="${mensajeId}" class="ia-mensaje-contenido">
                        ${contenido}
                    </div>
                `;
                
                // AÃ±adir evento al botÃ³n de voz
                setTimeout(() => {
                    const btnVoz = div.querySelector('.ia-btn-voz');
                    if (btnVoz) {
                        btnVoz.onclick = function() {
                            const mensajeId = this.getAttribute('data-mensaje-id');
                            const contenidoDiv = document.getElementById(mensajeId);
                            if (contenidoDiv) {
                                const texto = contenidoDiv.innerText || contenidoDiv.textContent;
                                sintetizarVoz(texto, this);
                            }
                        };
                    }
                }, 10);
            } else {
                div.innerHTML = `
                    <div class="ia-mensaje-header">
                        <strong>ðŸ‘¤ TÃº</strong>
                    </div>
                    <div>${contenido}</div>
                `;
            }
            
            iaConversacion.appendChild(div);
            iaConversacion.scrollTop = iaConversacion.scrollHeight;
            return div;
        }
        
        function agregarMensajeCarga() {
            const div = document.createElement('div');
            div.className = 'ia-mensaje-carga ia-pensando';
            div.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando consulta';
            iaConversacion.appendChild(div);
            iaConversacion.scrollTop = iaConversacion.scrollHeight;
            return div;
        }

        // ======================================================================
        // FUNCIÃ“N DE RECONOCIMIENTO DE VOZ CORREGIDA Y ROBUSTA
        // ======================================================================
        // FunciÃ³n de reconocimiento de voz corregida
        function startDictation(inputId) {
            // Verificar si el navegador soporta la API
            if (window.hasOwnProperty('webkitSpeechRecognition') || window.hasOwnProperty('SpeechRecognition')) {
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                var recognition = new SpeechRecognition();

                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = "es-AR"; // Configurado para espaÃ±ol Argentina
                
                // Indicador visual: Cambiar color del Ã­cono al empezar a escuchar
                const icon = document.querySelector(`i[onclick="startDictation('${inputId}')"]`);
                if(icon) icon.style.color = "red";

                recognition.start();

                recognition.onresult = function(event) {
                    var transcript = event.results[0][0].transcript;
                    var input = document.getElementById(inputId);
                    
                    if (input) {
                        // 1. Insertar el texto (respetando si ya habÃ­a algo escrito)
                        // Si quieres que reemplace todo, usa: input.value = transcript;
                        // Si quieres que agregue al final:
                        input.value = input.value ? input.value + " " + transcript : transcript;

                        // 2. IMPORTANTE: Disparar el evento para que funcionen los filtros
                        // Esto simula que el usuario escribiÃ³, activando el filtrado
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                        input.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true }));
                        
                        // Si es especÃ­ficamente el campo de bÃºsqueda global, forzar el filtro
                        if(inputId === 'buscador' && typeof actualizarFiltros === 'function'){
                            actualizarFiltros();
                        }
                    }
                    if(icon) icon.style.color = ""; // Restaurar color original
                    recognition.stop();
                };

                recognition.onerror = function(event) {
                    console.error("Error en reconocimiento de voz:", event.error);
                    if(icon) icon.style.color = ""; // Restaurar color
                    recognition.stop();
                };
                
                recognition.onend = function() {
                     if(icon) icon.style.color = ""; // Restaurar color al terminar
                };

            } else {
                alert("Tu navegador no soporta reconocimiento de voz. Por favor usa Google Chrome.");
            }
        }

        // FUNCIONES DE VOZ ORIGINALES - ACTUALIZADAS PARA USAR LA NUEVA FUNCIÃ“N
        function setupFuncionesVoz() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn("El navegador no soporta reconocimiento de voz");
                return;
            }
            
            // Configurar botones de voz existentes para usar startDictation
            const botonesVoz = {
                'Caratula': 'btnVoiceCaratula',
                'DatosNnya': 'btnVoiceDatosNnya',
                'NnyaGesell': 'btnVoiceNnyaGesell',
                'Observaciones': 'btnVoiceObservaciones',
                'Nota': 'btnVoiceNota',
                'Search': 'btnVoiceSearch'
            };
            
            // Mapeo de IDs de botÃ³n a IDs de campo
            const campoPorBoton = {
                'btnVoiceCaratula': 'caratula',
                'btnVoiceDatosNnya': 'datosNnya',
                'btnVoiceNnyaGesell': 'nnyaGesell',
                'btnVoiceObservaciones': 'observaciones-editor',
                'btnVoiceNota': 'notaBitacora',
                'btnVoiceSearch': 'buscador'
            };
            
            Object.keys(botonesVoz).forEach(campo => {
                const btn = $(botonesVoz[campo]);
                if (btn) {
                    // Obtener el ID del campo correspondiente
                    const campoId = campoPorBoton[botonesVoz[campo]];
                    
                    // Configurar el botÃ³n para usar startDictation
                    btn.onclick = () => startDictation(campoId);
                }
            });
            
            // Configurar botÃ³n de texto a voz en modal de ver
            const btnTextToSpeech = $('btnTextToSpeech');
            if (btnTextToSpeech) {
                btnTextToSpeech.onclick = function() {
                    const contenido = verContenido.innerText;
                    if ('speechSynthesis' in window) {
                        const sintesis = speechSynthesis;
                        const utterance = new SpeechSynthesisUtterance(contenido);
                        utterance.lang = 'es-ES';
                        utterance.rate = 1.0;
                        utterance.pitch = 1.0;
                        
                        this.classList.toggle('speaking');
                        if (sintesis.speaking) {
                            sintesis.cancel();
                            this.classList.remove('speaking');
                        } else {
                            sintesis.speak(utterance);
                            utterance.onend = () => {
                                this.classList.remove('speaking');
                            };
                        }
                    }
                };
            }
        }

        // INICIALIZACIÃ“N
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("Inicializando aplicaciÃ³n...");
            
            await cargarUsuarios();
            await cargarJuzgados();
            
            poblarTiposProceso();
            poblarSelectUsuarios();
            poblarFiltroTiposProceso();
            poblarFiltroIntervencion();
            poblarFiltroUsuarios();
            
            suscribirCausas(true);
            
            // Event Listeners
            $("btnNuevo").onclick = abrirNuevoExpediente;
            $("btnGuardar").onclick = guardarExpediente;
            // Cerrar modal al hacer clic fuera del contenido
modal.addEventListener('click', function(e) {
    if (e.target === modal) {
        modal.style.display = "none";
        resetFormCausa();
    }
});
            $("btnCerrarVer").onclick = () => modalVer.style.display = "none";
            $("btnCerrarEventosHoy").onclick = () => modalEventosHoy.style.display = "none";
            $("btnEventosHoy").onclick = () => {
                renderEventosHoy();
                modalEventosHoy.style.display = "flex";
            };
            $("btnAsistenteIA").onclick = abrirAsistenteIA;
            $("btnPrintFiltrado").onclick = () => window.print();
            $("btnPrintRegistro").onclick = () => window.print();
            
            // Asistente IA - Event Listeners
            btnNuevaConsultaIA.onclick = nuevaConsultaIA;
            btnSalirIA.onclick = cerrarAsistenteIA;
            btnVoiceIA.onclick = iniciarVozReconocimiento;
            iaEnviar.onclick = enviarPreguntaIA;
            iaPregunta.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarPreguntaIA();
                }
            });
            
            // Filtros
            buscador.addEventListener('input', actualizarFiltros);
            filtroEstado.addEventListener('change', actualizarFiltros);
            filtroUsuario.addEventListener('change', actualizarFiltros);
            filtroPrioridad.addEventListener('change', actualizarFiltros);
            filtroIntervencion.addEventListener('change', actualizarFiltros);
            filtroTipoProceso.addEventListener('change', actualizarFiltros);
            filtroEventos.addEventListener('change', actualizarFiltros);
            filtroFechaDesde.addEventListener('change', actualizarFiltros);
            filtroFechaHasta.addEventListener('change', actualizarFiltros);
            
            // Tabs
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    $(tabId).classList.add('active');
                });
            });
            
            // Editor de observaciones
            btnBold.onclick = () => {
                document.execCommand('bold', false, null);
                btnBold.classList.toggle('active');
            };
            btnColorAzul.onclick = () => document.execCommand('foreColor', false, '#007bff');
            btnColorRojo.onclick = () => document.execCommand('foreColor', false, '#dc3545');
            btnColorVerde.onclick = () => document.execCommand('foreColor', false, '#28a745');
            btnColorNormal.onclick = () => document.execCommand('foreColor', false, '#212529');
            
            // ValidaciÃ³n de existencia de expediente
            $("numCausa").addEventListener('blur', validarExistenciaExpediente);
            $("numCausa").addEventListener('input', function() {
                const field = this.closest('.field');
                field.classList.remove('error');
                const errorSpan = field.querySelector('.error-message');
                errorSpan.textContent = "Este campo es obligatorio.";
                errorSpan.style.color = "";
                errorSpan.style.fontWeight = "";
            });
            
            // Select de tipo de proceso para cargar juzgados
            selTipo.addEventListener('change', function() {
                poblarJuzgadosPorTipo(this.value);
            });
            
            // Select de recursos para mostrar campos opcionales
            $("recursos").addEventListener('change', function() {
                $("recursos-opcionales").style.display = this.value ? "block" : "none";
            });
            
            // Habilitar/deshabilitar Gesell
            $("habilitarAudienciaGesell").addEventListener('change', function() {
                $("audienciaGesell").disabled = !this.checked;
                $("nnyaGesell").disabled = !this.checked;
            });
            
            // Agregar audiencias y diligencias dinÃ¡micas
            btnAgregarAudiencia.onclick = function() {
                const container = audienciasContainer;
                const div = document.createElement('div');
                div.className = 'audiencia-item';
                div.innerHTML = `
                    <input type="datetime-local" class="audiencia-fecha">
                    <button type="button" class="btn-eliminar-audiencia"><i class="fa fa-trash"></i></button>
                `;
                container.appendChild(div);
                div.querySelector('.btn-eliminar-audiencia').onclick = function() {
                    container.removeChild(div);
                };
            };
            
            btnAgregarDiligencia.onclick = function() {
                const container = diligenciasContainer;
                const div = document.createElement('div');
                div.className = 'diligencia-item';
                div.innerHTML = `
                    <input type="datetime-local" class="diligencia-fecha">
                    <input type="text" class="diligencia-detalle" placeholder="Detalle">
                    <button type="button" class="btn-eliminar-diligencia"><i class="fa fa-trash"></i></button>
                `;
                container.appendChild(div);
                div.querySelector('.btn-eliminar-diligencia').onclick = function() {
                    container.removeChild(div);
                };
            };
            
            // Contadores de texto
            function setupContadores() {
                const editor = observacionesEditor;
                const counter = $("counter");
                editor.addEventListener('input', function() {
                    const texto = editor.innerText || "";
                    const palabras = texto.trim().split(/\s+/).filter(p => p.length > 0);
                    counter.textContent = `${palabras.length}/1000`;
                    if (palabras.length > 1000) {
                        counter.style.color = 'red';
                    } else {
                        counter.style.color = '';
                    }
                    observacionesHidden.value = editor.innerHTML;
                });
                
                const contadores = [
                    { campo: $("datosNnya"), contador: $("counterNnya"), max: 500 },
                    { campo: $("nnyaGesell"), contador: $("counterNnyaGesell"), max: 400 }
                ];
                contadores.forEach(item => {
                    if (item.campo) {
                        item.campo.addEventListener('input', function() {
                            const palabras = this.value.trim().split(/\s+/).filter(p => p.length > 0);
                            item.contador.textContent = `${palabras.length}/${item.max}`;
                            if (palabras.length > item.max) {
                                item.contador.style.color = 'red';
                            } else {
                                item.contador.style.color = '';
                            }
                        });
                        item.contador.style.display = 'block';
                    }
                });
            }
            setupContadores();
            
            // Funciones de voz
            setupFuncionesVoz();
            
            console.log("AplicaciÃ³n inicializada correctamente.");
        });

        // FUNCIÃ“N PARA MIGRAR DATOS CORREGIDA
        window.migrarDatosParaBusqueda = async function() {
            if (!db) {
                alert("Firebase no estÃ¡ inicializado");
                return;
            }
            
            const confirmar = confirm("Esta operaciÃ³n actualizarÃ¡ todos los registros para habilitar bÃºsquedas avanzadas. Â¿Continuar?");
            if (!confirmar) return;
            
            try {
                const snapshot = await db.collection("causas").get();
                const batch = db.batch();
                let contador = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Generar keywords
                    const textoParaKeywords = [
                        data.numCausa || '',
                        data.caratula || '', 
                        data.usuarioAsignado || '',
                        data.observaciones || ''
                    ]
                    .filter(Boolean)
                    .join(' ')
                    .toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^\w\s]/gi, '')
                    .split(/\s+/)
                    .filter(palabra => palabra.length > 0);
                    
                    // Generar fechasFiltro
                    const fechasSet = new Set();
                    const agregarFecha = (fecha) => {
                        if (!fecha) return;
                        const d = toDate(fecha);
                        if (d && !isNaN(d)) {
                            fechasSet.add(formatFechaParaInput(d, false));
                        }
                    };
                    
                    agregarFecha(data.vencimiento);
                    agregarFecha(data.vencimientoRecursos);
                    agregarFecha(data.audienciaGesell);
                    if (Array.isArray(data.audiencias)) {
                        data.audiencias.forEach(agregarFecha);
                    }
                    if (Array.isArray(data.diligencias)) {
                        data.diligencias.forEach(dilig => agregarFecha(dilig.fecha));
                    }
                    
                    // Actualizar documento
                    const ref = db.collection("causas").doc(doc.id);
                    batch.update(ref, {
                        keywords: textoParaKeywords,
                        fechasFiltro: Array.from(fechasSet)
                    });
                    
                    contador++;
                });
                
                await batch.commit();
                alert(`Se actualizaron ${contador} registros correctamente.`);
                location.reload();
            } catch (error) {
                console.error("Error en migraciÃ³n:", error);
                alert("Error durante la migraciÃ³n: " + error.message);
            }
        };
    </script>
</body>
</html>
